diff a/FacturacionVERIFACTU.API/Data/Services/FacturaService.cs b/FacturacionVERIFACTU.API/Data/Services/FacturaService.cs	(rejected hunks)
@@ -133,57 +133,54 @@ namespace FacturacionVERIFACTU.API.Data.Services
             foreach (var lineaDto in dto.Lineas)
             {
                 Producto? producto = null;
                 if (lineaDto.ProductoId.HasValue && productosDict.ContainsKey(lineaDto.ProductoId.Value))
                 {
                     producto = productosDict[lineaDto.ProductoId.Value];
                 }
 
                 var (tipoImpuesto, iva, recargo) = ResolverTipoImpuesto(
                     tiposImpuestoActivos,
                     lineaDto.TipoImpuestoId,
                     producto,
                     lineaDto.IVA);
 
                 if (!cliente.RegimenRecargoEquivalencia)
                 {
                     recargo = 0m;
                 }
 
                 var linea = new LineaFactura
                 {
                     Orden = orden++,
                     Descripcion = lineaDto.Descripcion,
                     Cantidad = lineaDto.Cantidad,
                     PrecioUnitario = lineaDto.PrecioUnitario,
-                    IVA = iva,                              // ⭐ APLICADO AUTOMÁTICAMENTE
-                    RecargoEquivalencia = recargo,          // ⭐ APLICADO AUTOMÁTICAMENTE
                     IvaPercentSnapshot = iva,
                     RePercentSnapshot = recargo,
                     TipoImpuestoId = tipoImpuesto?.Id,
                     ProductoId = lineaDto.ProductoId,
-                    Importe = Math.Round(lineaDto.Cantidad * lineaDto.PrecioUnitario, 2)
                 };
 
                 CalcularLineaFactura(linea);
                 factura.Lineas.Add(linea);
             }
 
             // Calcular totales
             CalcularTotalesFactura(factura);
             ValidarTipoFacturaVerifactu(factura.TipoFacturaVERIFACTU);
 
             // Log de configuración fiscal aplicada
             if (cliente.RegimenRecargoEquivalencia)
             {
                 _logger.LogInformation(
                     "Factura {Numero}: Aplicado recargo equivalencia. Total recargo: {TotalRecargo}€",
                     numeroCompleto, factura.TotalRecargo);
             }
 
             if (porcentajeRetencion > 0)
             {
                 _logger.LogInformation(
                     "Factura {Numero}: Aplicada retención {Porcentaje}%. Cuota: {Cuota}€",
                     numeroCompleto, porcentajeRetencion, factura.CuotaRetencion);
             }
 
@@ -338,77 +335,71 @@ namespace FacturacionVERIFACTU.API.Data.Services
                 }
 
                 var (tipoImpuesto, iva, recargo) = ResolverTipoImpuesto(
                     tiposImpuestoActivos,
                     lineaDto.TipoImpuestoId,
                     producto,
                     lineaDto.IVA);
 
                 if (!clienteActual.RegimenRecargoEquivalencia)
                 {
                     recargo = 0m;
                 }
 
                 if (lineaDto.Id.HasValue && lineaDto.Id.Value > 0)
                 {
                     // Actualizar línea existente
                     var lineaExistente = factura.Lineas
                         .FirstOrDefault(l => l.Id == lineaDto.Id.Value);
 
                     if (lineaExistente != null)
                     {
                         lineaExistente.Orden = orden++;
                         lineaExistente.Descripcion = lineaDto.Descripcion;
                         lineaExistente.Cantidad = lineaDto.Cantidad;
                         lineaExistente.PrecioUnitario = lineaDto.PrecioUnitario;
-                        lineaExistente.IVA = iva;                          // ⭐ RECALCULADO
-                        lineaExistente.RecargoEquivalencia = recargo;       // ⭐ RECALCULADO
                         lineaExistente.IvaPercentSnapshot = iva;
                         lineaExistente.RePercentSnapshot = recargo;
                         lineaExistente.TipoImpuestoId = tipoImpuesto?.Id;
                         lineaExistente.ProductoId = lineaDto.ProductoId;
-                        lineaExistente.Importe = Math.Round(lineaDto.Cantidad * lineaDto.PrecioUnitario, 2);
                         CalcularLineaFactura(lineaExistente);
                     }
                 }
                 else
                 {
                     // Crear línea nueva
                     var lineaNueva = new LineaFactura
                     {
                         FacturaId = factura.Id,
                         Orden = orden++,
                         Descripcion = lineaDto.Descripcion,
                         Cantidad = lineaDto.Cantidad,
                         PrecioUnitario = lineaDto.PrecioUnitario,
-                        IVA = iva,                                  // ⭐ CALCULADO
-                        RecargoEquivalencia = recargo,              // ⭐ CALCULADO
                         IvaPercentSnapshot = iva,
                         RePercentSnapshot = recargo,
                         TipoImpuestoId = tipoImpuesto?.Id,
                         ProductoId = lineaDto.ProductoId,
-                        Importe = Math.Round(lineaDto.Cantidad * lineaDto.PrecioUnitario, 2)
                     };
 
                     CalcularLineaFactura(lineaNueva);
                     factura.Lineas.Add(lineaNueva);
                 }
             }
 
             // Recalcular totales
             CalcularTotalesFactura(factura);
 
             // Log de cambios fiscales
             _logger.LogInformation(
                 "Factura {Numero} actualizada. Cliente en recargo: {Recargo}. Retención: {Retencion}%",
                 factura.Numero, clienteActual.RegimenRecargoEquivalencia, factura.PorcentajeRetencion);
 
             // Regenerar hash VERIFACTU
             await AplicarVERIFACTUAsync(factura);
 
             await _context.SaveChangesAsync();
 
             _logger.LogInformation("Actualizada factura {Numero} para tenant {TenantID}", factura.Numero, tenantId);
 
             return await MapearAResponseDto(factura);
         }
 
@@ -832,67 +820,67 @@ namespace FacturacionVERIFACTU.API.Data.Services
                 ActualizadoEn = DateTime.UtcNow
             };
 
             var productosIds = presupuestos
                 .SelectMany(p => p.Lineas)
                 .Where(l => l.ProductoId.HasValue)
                 .Select(l => l.ProductoId.Value)
                 .Distinct()
                 .ToList();
 
             Dictionary<int, Producto> productosDict = new();
 
             if (productosIds.Any())
             {
                 var productos = await _context.Productos
                     .Where(p => productosIds.Contains(p.Id))
                     .ToListAsync();
 
                 productosDict = productos.ToDictionary(p => p.Id);
             }
 
             var orden = 1;
             foreach (var lineaPresupuesto in presupuestos.SelectMany(p => p.Lineas).OrderBy(l => l.Orden))
             {
                 decimal iva = lineaPresupuesto.IvaPercentSnapshot;
-                decimal recargo = lineaPresupuesto.RecargoEquivalencia;
-
-             
+                decimal recargo = cliente.RegimenRecargoEquivalencia
+                    ? lineaPresupuesto.RePercentSnapshot
+                    : 0m;
 
                 var lineaFactura = new LineaFactura
                 {
                     Orden = orden++,
                     Descripcion = lineaPresupuesto.Descripcion,
                     Cantidad = lineaPresupuesto.Cantidad,
                     PrecioUnitario = lineaPresupuesto.PrecioUnitario,
-                    IVA = iva,
+                    IvaPercentSnapshot = iva,
                     RePercentSnapshot = recargo,
                     TipoImpuestoId = lineaPresupuesto.TipoImpuestoId,
-                    ProductoId = lineaPresupuesto.ProductoId,
-                    Importe = Math.Round(lineaPresupuesto.Cantidad * lineaPresupuesto.PrecioUnitario, 2)
+                    ProductoId = lineaPresupuesto.ProductoId
                 };
 
+                CalcularLineaFactura(lineaFactura);
                 factura.Lineas.Add(lineaFactura);
             }
 
             CalcularTotalesFactura(factura);
             ValidarTipoFacturaVerifactu(factura.TipoFacturaVERIFACTU);
 
             var facturaAnterior = await _context.Facturas
                 .Where(f => f.SerieId == dto.SerieId && f.TenantId == tenantId)
                 .OrderByDescending(f => f.FechaEmision)
                 .ThenByDescending(f => f.Id)
                 .FirstOrDefaultAsync();
 
             factura.HuellaAnterior = facturaAnterior?.Huella;
 
             await AplicarVERIFACTUAsync(factura);
 
             _context.Facturas.Add(factura);
             await _context.SaveChangesAsync();
 
             foreach (var presupuesto in presupuestos)
             {
                 presupuesto.FacturaId = factura.Id;
                 presupuesto.Estado = "Facturado";
             }
 
@@ -1092,98 +1077,92 @@ namespace FacturacionVERIFACTU.API.Data.Services
             // Base Imponible = Σ(Cantidad × Precio) de todas las líneas
             factura.BaseImponible = factura.Lineas.Sum(l => l.BaseImponible);
 
             // Total IVA = Σ(Base línea × IVA% línea)
             factura.TotalIVA = Math.Round(
                 factura.Lineas.Sum(l => l.ImporteIva), 2);
 
             // Total Recargo = Σ(Base línea × Recargo% línea)
             factura.TotalRecargo = Math.Round(
                 factura.Lineas.Sum(l => l.ImporteRecargo), 2);
 
             // Cuota Retención = Base Imponible Total × Retención%
             factura.CuotaRetencion = Math.Round(
                 factura.BaseImponible * (factura.PorcentajeRetencion ?? 0m) / 100, 2);
 
             // TOTAL FACTURA = Base + IVA + Recargo - Retención
             factura.Total = factura.BaseImponible
                           + factura.TotalIVA
                           + factura.TotalRecargo
                           - factura.CuotaRetencion ?? 0m;
         }
 
         private void CalcularLineaFactura(LineaFactura linea)
         {
             var subtotal = linea.Cantidad * linea.PrecioUnitario;
-            linea.BaseImponible = subtotal;
-            linea.ImporteIva = subtotal * (linea.IvaPercentSnapshot / 100);
-            linea.ImporteRecargo = subtotal * (linea.RePercentSnapshot / 100);
-            linea.TotalLineaSnapshot = subtotal + linea.ImporteIva + linea.ImporteRecargo;
-            linea.Importe = subtotal;
+            linea.BaseImponible = Math.Round(subtotal, 2);
+            linea.ImporteIva = Math.Round(linea.BaseImponible * (linea.IvaPercentSnapshot / 100), 2);
+            linea.ImporteRecargo = Math.Round(linea.BaseImponible * (linea.RePercentSnapshot / 100), 2);
+            linea.Importe = Math.Round(linea.BaseImponible + linea.ImporteIva + linea.ImporteRecargo, 2);
         }
 
         private async Task<List<TipoImpuesto>> ObtenerTiposImpuestoActivosAsync(int tenantId)
         {
             return await _context.TiposImpuesto
                 .Where(t => t.TenantId == tenantId && t.Activo)
                 .ToListAsync();
         }
 
         private (TipoImpuesto? TipoImpuesto, decimal Iva, decimal Recargo) ResolverTipoImpuesto(
             List<TipoImpuesto> tiposImpuestoActivos,
             int? tipoImpuestoId,
             Producto? producto,
             decimal? ivaOverride)
         {
             TipoImpuesto? tipoImpuesto = null;
 
             if (tipoImpuestoId.HasValue)
             {
                 tipoImpuesto = tiposImpuestoActivos.FirstOrDefault(t => t.Id == tipoImpuestoId.Value);
                 if (tipoImpuesto == null)
                     throw new InvalidOperationException("Tipo de impuesto no válido o inactivo");
             }
             else if (producto?.TipoImpuestoId.HasValue == true)
             {
                 tipoImpuesto = tiposImpuestoActivos.FirstOrDefault(t => t.Id == producto.TipoImpuestoId.Value);
                 if (tipoImpuesto == null)
                     throw new InvalidOperationException("Tipo de impuesto del producto no válido o inactivo");
             }
             else if (ivaOverride.HasValue)
             {
                 tipoImpuesto = tiposImpuestoActivos.FirstOrDefault(t => t.PorcentajeIva == ivaOverride.Value);
             }
-            else if (producto?.IVA > 0)
-            {
-                tipoImpuesto = tiposImpuestoActivos.FirstOrDefault(t => t.PorcentajeIva == producto.IVA);
-            }
 
             tipoImpuesto ??= tiposImpuestoActivos.FirstOrDefault(t => t.Nombre == "General");
 
             var iva = tipoImpuesto?.PorcentajeIva
                 ?? ivaOverride
-                ?? producto?.IVA
                 ?? 0m;
 
             var recargo = tipoImpuesto?.PorcentajeRecargo ?? 0m;
 
             return (tipoImpuesto, iva, recargo);
         }
 
         private static readonly HashSet<string> TiposFacturaVerifactuPermitidos = new(StringComparer.OrdinalIgnoreCase)
         {
             "F1",
             "F2",
             "F3",
             "R1",
             "R2",
             "R3",
             "R4"
         };
 
         private static string DeterminarTipoFacturaVerifactu(Cliente cliente)
         {
             if (cliente == null)
             {
                 return "F2";
             }
 
@@ -1324,37 +1303,37 @@ namespace FacturacionVERIFACTU.API.Data.Services
                 UrlVERIFACTU = factura.UrlVERIFACTU,
                 QRBase64 = factura.QRVerifactu != null
                     ? Convert.ToBase64String(factura.QRVerifactu)
                     : null,
                 NumeroFacturaRectificada = factura.NumeroFacturaRectificada,
                 TipoRectificacion = factura.TipoRectificacion,
                 AlbaranesIds = albaranesIds,
 
                 Lineas = factura.Lineas.Select(l => new LineaFacturaResponseDto
                 {
                     Id = l.Id,
                     Orden = l.Orden,
                     ProductoId = l.ProductoId,
                     ProductoCodigo = l.Producto?.Codigo,
                     Descripcion = l.Descripcion,
                     Cantidad = l.Cantidad,
                     PrecioUnitario = l.PrecioUnitario,
                     PorcentajeDescuento = 0,
                     ImporteDescuento = 0,
                     BaseImponible = l.BaseImponible,
                     IVA = l.IvaPercentSnapshot,
                     RecargoEquivalencia = l.RePercentSnapshot, // ⭐ NUEVO
                     ImporteIva = l.ImporteIva,
                     ImporteRecargo = l.ImporteRecargo, // ⭐ NUEVO
                     Importe = l.Importe,
-                    TotalLinea = l.TotalLineaSnapshot,
+                    TotalLinea = l.Importe,
                     TipoImpuestoId = l.TipoImpuestoId
                 }).OrderBy(l => l.Orden).ToList(),
 
                 FechaCreaccion = DateTime.UtcNow,
                 FechaModificacion = factura.ActualizadoEn // ⭐ NUEVO
             };
         }
 
         #endregion
     }
-}
\ No newline at end of file
+}
