@using Microsoft.AspNetCore.Components.Web

@if (IsOpen)
{
    <div class="notion-modal-overlay is-open"
         style="position:fixed; inset:0; z-index:999999; display:flex; align-items:center; justify-content:center; padding:16px; background:rgba(15,15,15,.4);"
         tabindex="0"
         @ref="overlayRef"
         @onkeydown="HandleKeyDown"
         @onclick="HandleOverlayClick">
        <div class="notion-modal"
             style="max-width:480px; width:100%; background:#fff; border-radius:14px; padding:24px; box-shadow:0 16px 40px rgba(0,0,0,.18);"
             role="dialog" aria-modal="true" aria-labelledby="notion-modal-title"
             @onclick:stopPropagation="true">

            <div class="notion-modal-header">
                <h3 id="notion-modal-title">@Title</h3>
            </div>
            <div class="notion-modal-body">
                <p>@Message</p>
            </div>
            <div class="notion-modal-actions"
                 style="display:flex; flex-direction:row; justify-content:flex-end; gap:12px;">

                <button type="button"
                        class="btn-modern-secondary notion-modal-cancel"
                        style="width:auto"
                        @onclick="HandleCancel"
                        disabled="@IsBusy">
                    @CancelText
                </button>

                <button type="button"
                        class="btn-modern notion-modal-confirm @(Danger ? "is-danger" : string.Empty)"
                        style="width:auto"
                        @onclick="HandleConfirm"
                        disabled="@IsBusy">
                    @if (IsBusy)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Eliminando…</span>
                    }
                    else
                    {
                        <span>@ConfirmText</span>
                    }
                </button>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string Message { get; set; } = string.Empty;
    [Parameter] public string ConfirmText { get; set; } = "Eliminar";
    [Parameter] public string CancelText { get; set; } = "Cancelar";
    [Parameter] public bool Danger { get; set; }
    [Parameter] public bool IsBusy { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnConfirm { get; set; }

    private ElementReference overlayRef;
    private bool shouldFocus;

    protected override void OnParametersSet()
    {
        if (IsOpen)
        {
            shouldFocus = true;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldFocus)
        {
            shouldFocus = false;
            await overlayRef.FocusAsync();
        }
    }

    private async Task HandleOverlayClick()
    {
        if (!IsBusy)
        {
            await OnCancel.InvokeAsync();
        }
    }

    private async Task HandleCancel()
    {
        if (!IsBusy)
        {
            await OnCancel.InvokeAsync();
        }
    }

    private async Task HandleConfirm()
    {
        if (!IsBusy)
        {
            await OnConfirm.InvokeAsync();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Escape" && !IsBusy)
        {
            await OnCancel.InvokeAsync();
        }
    }
}

