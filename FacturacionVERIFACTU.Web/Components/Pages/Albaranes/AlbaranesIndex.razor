@page "/albaranes"
@using FacturacionVERIFACTU.Web.Models.DTOs
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ConfirmDialogService ConfirmDialog
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Albaranes - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-truck"></i>
            </span>
            <div>
                <h1>Albaranes</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevoAlbaran">
            <i class="bi bi-plus-lg"></i> Nuevo Albarán
        </button>
    </div>

    <!-- Tabs de Estado con estilo Notion -->
    <div class="notion-toolbar" style="border-bottom: 1px solid #edeceb; margin-bottom: 24px;">
        <div class="notion-tabs">
            @foreach (var estado in estadosDisponibles)
            {
                <button class="notion-tab @(estado.Valor == estadoSeleccionado ? "active" : string.Empty)"
                        @onclick="() => CambiarEstado(estado.Valor)">
                    <span>@estado.Etiqueta</span>
                    <span class="tab-count">@ObtenerConteo(estado.Valor)</span>
                </button>
            }
        </div>
    </div>

    <!-- Barra de acciones masivas (cuando hay selección) -->
    @if (seleccionados.Any())
    {
        <div class="ui-card" style="padding: 14px; margin-bottom: 24px;">
            <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
                <div class="notion-input-group">
                    <span style="font-weight: 600;">@seleccionados.Count seleccionado(s)</span>
                </div>

                <!-- Botones en una sola fila -->
                <div class="notion-input-group bulk-actions">
                    @if (seleccionados.All(id => albaranes.First(a => a.Id == id).Estado == "Pendiente"))
                    {
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => MarcarComoEnviado("Entregado")'>
                            <i class="bi bi-check-circle"></i> Marcar como Entregado
                        </button>
                    }

                    @if (seleccionados.All(id => albaranes.First(a => a.Id == id).Estado == "Entregado"))
                    {
                        <button class="btn-modern-secondary bulk-btn" @onclick='ConvertirAFacturaMasivo'>
                            <i class="bi bi-receipt"></i> Convertir a Factura
                        </button>
                    }

                    <button class="btn-modern-secondary bulk-btn" @onclick="ExportarSeleccionados">
                        <i class="bi bi-download"></i> Exportar PDFs
                    </button>
                </div>
            </div>

        </div>
    }

    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando albaranes...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
        </div>
    }
    else if (albaranes == null || !albaranesFiltrados.Any())
    {
        <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
            <i class="bi bi-truck" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
            <h4 style="font-weight: 600; margin-bottom: 8px;">No hay albaranes</h4>
            <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">
                @(estadoSeleccionado == null ? "Crea tu primer albarán de entrega." : $"No hay albaranes en estado {estadoSeleccionado}")
            </p>
            @if (estadoSeleccionado == null)
            {
                <button class="btn-modern-secondary" @onclick="NuevoAlbaran">Crear albarán</button>
            }
        </div>
    }
    else
    {
        <div class="notion-table-wrapper">
            <table class="notion-table">
                <thead>
                    <tr>
                        <th style="width: 4%; text-align: center;">
                            <input type="checkbox" @onchange="ToggleSeleccionarTodos" checked="@TodosSeleccionados" />
                        </th>
                        <th style="width: 20%; text-align: left;">NÚMERO</th>
                        <th style="width: 24%; text-align: left;">CLIENTE</th>
                        <th style="width: 14%; text-align: left;">F. EMISIÓN</th>
                        <th style="width: 17%; text-align: right;">TOTAL</th>
                        <th style="width: 10%; text-align: center;">ESTADO</th>
                        <th style="width: 15%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var albaran in albaranesFiltrados)
                    {
                        <tr>
                            <td style="text-align: center;">
                                <input type="checkbox"
                                       checked="@seleccionados.Contains(albaran.Id)"
                                       @onchange="(e) => ToggleSeleccion(albaran, e)" />
                            </td>
                            <td>
                                <div class="notion-cell-title">@albaran.SerieCodigo-@albaran.Numero</div>
                                <div class="notion-cell-desc">Ejercicio @albaran.Ejercicio</div>
                            </td>
                            <td>
                                <div class="notion-cell-title">@albaran.ClienteNombre</div>
                            </td>
                            <td>
                                <span style="color: #787774; font-size: 14px;">@albaran.FechaEmision.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td style="text-align: right;">
                                <span style="font-weight: 600;">@albaran.Total.ToString("C")</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="notion-badge badge-@ObtenerClaseEstado(albaran.Estado)">@albaran.Estado</span>
                            </td>
                            <td style="text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                    <button class="notion-action-btn"
                                            title="Ver/Editar"
                                            @onclick="() => EditarAlbaran(albaran)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn"
                                            title="Descargar PDF"
                                            @onclick="() => DescargarPDF(albaran.Id)">
                                        <i class="bi bi-file-pdf"></i>
                                    </button>
                                    @if (albaran.Estado == "Entregado" && !albaran.Facturado)
                                    {
                                        <button class="notion-action-btn"
                                                title="Convertir a Factura"
                                                @onclick="() => ConvertirAFactura(albaran.Id)">
                                            <i class="bi bi-receipt"></i>
                                        </button>
                                    }
                                    @if (albaran.Estado == "Pendiente")
                                    {
                                        <button class="notion-action-btn delete"
                                                title="Eliminar"
                                                @onclick="() => EliminarAlbaran(albaran)">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
            <span>Total: @albaranesFiltrados.Count() albaranes (@albaranesFiltrados.Sum(a => a.Total).ToString("C"))</span>
        </div>
    }
</div>

@code {
    [Inject] private IJSRuntime JS { get; set; } = null!;
    [Inject] private HttpClient Http { get; set; } = null!;

    private sealed record EstadoTab(string Etiqueta, string? Valor);


    private List<AlbaranResponseDto> albaranes = new();
    private HashSet<int> seleccionados = new();
    private string? estadoSeleccionado = null;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    private readonly List<EstadoTab> estadosDisponibles = new()
    {
        new("Todos", null),
        new("Pendiente", "Pendiente"),
        new("Entregado", "Entregado"),
        new("Facturado", "Facturado"),
        new("Anulado", "Anulado")
    };

    private IEnumerable<AlbaranResponseDto> albaranesFiltrados =>
        estadoSeleccionado == null
            ? albaranes
            : albaranes.Where(a => a.Estado == estadoSeleccionado);

    private bool TodosSeleccionados =>
        albaranesFiltrados.Any() && albaranesFiltrados.All(a => seleccionados.Contains(a.Id));

    protected override async Task OnInitializedAsync()
    {
        await CargarAlbaranesAsync();
    }

    private async Task CargarAlbaranesAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var response = await ApiService.GetAsync<List<AlbaranResponseDto>>("api/albaranes");
            albaranes = response ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar albaranes: {ex.Message}";
            albaranes = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CambiarEstado(string? estado)
    {
        estadoSeleccionado = estado;
        seleccionados.Clear(); 
    }

    private int ObtenerConteo(string? estado)
    {
        return estado == null
            ? albaranes.Count
            : albaranes.Count(a => a.Estado == estado);
    }

    private string ObtenerClaseEstado(string estado) => estado switch
    {
        "Pendiente" => "warning",
        "Entregado" => "info",
        "Facturado" => "success",
        "Anulado" => "error",
        _ => "default"
    };

    private void ToggleSeleccion(AlbaranResponseDto albaran, ChangeEventArgs e)
    {
        var marcado = (bool)(e.Value ?? false);
        if (marcado)
            seleccionados.Add(albaran.Id);
        else
            seleccionados.Remove(albaran.Id);
    }

    private void ToggleSeleccionarTodos(ChangeEventArgs e)
    {
        var marcado = (bool)(e.Value ?? false);
        if (marcado)
        {
            foreach (var albaran in albaranesFiltrados)
                seleccionados.Add(albaran.Id);
        }
        else
        {
            seleccionados.Clear();
        }
    }

    private void LimpiarSeleccion()
    {
        seleccionados.Clear();
    }

    private void NuevoAlbaran()
    {
        Navigation.NavigateTo("/albaranes/nuevo");
    }

    private void EditarAlbaran(AlbaranResponseDto albaran)
    {
        Navigation.NavigateTo($"/albaranes/editar/{albaran.Id}");
    }

    private async Task ExportarSeleccionados()
    {
        if (!seleccionados.Any()) return;

        try
        {
            foreach (var id in seleccionados)
            {
                var response = await Http.GetAsync($"api/albaranes/{id}/pdf");

                if (!response.IsSuccessStatusCode) return;

                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"Albaran_{id}.pdf";

                var base64 = Convert.ToBase64String(fileBytes);
                await JS.InvokeVoidAsync("downloadFile", fileName, base64);
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
    }

    private async Task DescargarPDF(int id)
    {
        try
        {
            var response = await Http.GetAsync($"api/albaranes/{id}/pdf");

            if (!response.IsSuccessStatusCode)
            {
                return;
            }

            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var fileName = $"Albaran_{id}.pdf";

            var base64 = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
    }

    private void ConvertirAFactura(int id)
    {
        var options = new ConfirmDialogOptions(
            "¿Convertir a factura?",
            "Este albarán se convertirá en una factura.",
            "Convertir",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            Navigation.NavigateTo($"/facturas/desde-albaran/{id}");
            await Task.CompletedTask;
        });
    }

    private void ConvertirAFacturaMasivo()
    {
        if (!seleccionados.Any()) return;

        var options = new ConfirmDialogOptions(
            "¿Convertir a factura?",
            $"Se convertirán {seleccionados.Count} albarán(es) a factura.",
            "Convertir",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            var ids = string.Join(",", seleccionados);
            Navigation.NavigateTo($"/facturas/desde-albaranes?ids={ids}");
            await Task.CompletedTask;
        });
    }



    private void MarcarComoEnviado(string nuevoEstado)
    {
        if (!seleccionados.Any()) return;

        //Verificar que todos los seleccionados estan en estado pendiente
        var albaranesPendientes = albaranes
        .Where(a => seleccionados.Contains(a.Id) && a.Estado == "Pendiente")
        .ToList();

        if (!albaranesPendientes.Any())
        {
            return;
        }

        var options = new ConfirmDialogOptions(
            "¿Marcar como entregados",
            $"Se marcaran {albaranesPendientes.Count} albara(es) como entregados",
            "Marcar como entregados",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
     {
         foreach (var albaran in albaranesPendientes)
         {
             try
             {
                 var request = new CambiarEstadoAlbaranDto { NuevoEstado = "Entregado" };
                 var result = await ApiService.PatchAsync<CambiarEstadoAlbaranDto, AlbaranResponseDto>(
                     $"api/albaranes/{albaran.Id}/estado", request);

                 if (result == null)
                 {
                     throw new InvalidOperationException($"Error al cambiar estado del albarán {albaran.Id}");
                 }
             }
             catch (Exception ex)
             {
                 throw new InvalidOperationException($"Error en albarán {albaran.Id}: {ex.Message}");
             }
         }

         // Recargar lista y limpiar selección
         await CargarAlbaranesAsync();
         seleccionados.Clear();
         await InvokeAsync(StateHasChanged);
     });
    }

    private void EliminarAlbaran(AlbaranResponseDto albaran)
    {
        var options = new ConfirmDialogOptions(
            "¿Eliminar albarán?",
            $"El albarán {albaran.SerieCodigo}-{albaran.Numero} se borrará permanentemente. Esta acción no se puede deshacer.",
            "Eliminar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            var result = await ApiService.DeleteAsyncDetailed($"api/albaranes/{albaran.Id}");

            if (!result.Success)
            {
                var message = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "No se pudo eliminar el albarán."
                    : result.ErrorMessage;
                throw new InvalidOperationException(message);
            }

            await CargarAlbaranesAsync();
            await InvokeAsync(StateHasChanged);
        });
    }
}
