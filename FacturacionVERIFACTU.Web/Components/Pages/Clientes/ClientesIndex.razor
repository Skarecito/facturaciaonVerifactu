@page "/clientes"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Clientes - FacturaVERIFACTU</PageTitle>

<div class="notion-content">
    @* CABEZERA ESTILO NOTION*@
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-people-fill"></i>
            </span>
            <div>
                <h1>Clientes</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevoCliente">
            <i class="bi bi-plus-lg"></i> Nuevo Cliente
        </button>
    </div>
</div>

@* TOOLBAR DE BUSCQUEDA*@
<div class="notion-toolbar" style="border-bottom: 1px solid #edeceb; margin-bottom: 30px;">
    <div class="notion-search-wrapper" style="max-width: 100%; border: none;">
        <i class="bi bi-search" style="font-size: 14 px;"></i>
        <input @bind="searchText"
               @bind:event="oninput"
               @onkeyup="Buscar"
               placeholder="Buscar por razón social, CIF..."
               class="notion-search-input" />
    </div>
</div>

@* Contenido principal*@
@if (isLoading)
{
    <div class="notion-loading">
        <div class="spinner-modern"></div>
        <span>Cargando base de datos...</span>
    </div>
}
else if(clientes == null || !clientes.Any())
{
    <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
        <i class="bi bi-person-vcard" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
        <h4 style="font-weight: 600; margin-bottom: 8px;">No hay clientes</h4>
        <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">Empieza agregando tu primer cliente para facturar.</p>
        <button class="notion-button primary" @onclick="NuevoCliente">Añadir cliente</button>
    </div>
}
else
{
    <div class="notion-table-wrapper">
        <table class="notion-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--notion-border);">
                    <th style="padding: 12px 16px; width: 35%; text-align: left;">RAZÓN SOCIAL</th>
                    <th style="padding: 12px 16px; width: 15%; text-align: left;">CIF / NIF</th>
                    <th style="padding: 12px 16px; width: 25%; text-align: left;">EMAIL</th>
                    <th style="padding: 12px 16px; width: 10%; text-align: center;">ESTADO</th>
                    <th style="padding: 12px 16px; width: 15%; text-align: right;">ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cliente in clientes)
                {
                    <tr class="@(cliente.Activo? "" : "notion-row-inactive")">
                        <td style="padding: 16px">
                            <div class="notion-cell-title">@cliente.Nombre</div>
                        </td>
                        <td style="padding: 16px">
                            <span class="notion-code-text">@cliente.NIF</span>
                        </td>
                        <td style="padding: 16px">
                            <span style="color: #787774; font-size: 14px;">@(cliente.Email ?? "-")</span>
                        </td>
                        <td style="padding 16px; text-align: center">
                            <span class="notion-badge @(cliente.Activo ? "active" : "inactive")">
                                @(cliente.Activo ? "Activo" : "Inactivo")
                            </span>
                        </td>
                        <td style="padding: 16px; text-align: right;">
                            <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                <button class="notion-action-btn" @onclick="() => EditarCliente(cliente)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="notion-action-btn delete" @onclick="() => EliminarCliente(cliente)">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
        <span>Mostrando @clientes.Count clientes</span>
    </div>
}

@code {
    private List<ClienteDto> clientes = new();
    private string searchText = string.Empty;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    private readonly IReadOnlyList<DataTableColumn<ClienteDto>> columns =
    [
        new DataTableColumn<ClienteDto> { Header = "Razón social", Value = item => item.Nombre },
        new DataTableColumn<ClienteDto> { Header = "CIF/NIF", Value = item => item.NIF },
        new DataTableColumn<ClienteDto> { Header = "Email", Value = item => item.Email ?? "-" }
    ];

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await CargarClientesAsync();
    }

    private async Task CargarClientesAsync(string? search = null)
    {
        isLoading = true;
        errorMessage = string.Empty;

        var endpoint = string.IsNullOrWhiteSpace(search)
            ? "api/clientes"
            : $"api/clientes?search={Uri.EscapeDataString(search)}";

        var response = await ApiService.GetAsync<PaginatedResponseDto<ClienteDto>>(endpoint);
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los clientes.";
            clientes = new List<ClienteDto>();
        }
        else
        {
            clientes = response.Items;
        }

        isLoading = false;
    }

    private async Task Buscar()
    {
        await CargarClientesAsync(searchText);
    }

    private void NuevoCliente() => NavManager.NavigateTo("/clientes/nuevo");

    private void EditarCliente(ClienteDto cliente) => NavManager.NavigateTo($"/clientes/editar/{cliente.ClienteId}");

    private async Task EliminarCliente(ClienteDto cliente)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar a {cliente.Nombre}?");
        if (!confirm)
        {
            return;
        }

        var success = await ApiService.DeleteAsync($"api/clientes/{cliente.ClienteId}");
        if (!success)
        {
            errorMessage = "No se pudo eliminar el cliente.";
            return;
        }

        await CargarClientesAsync(searchText);
    }
}
