@page "/clientes"
@using Microsoft.AspNetCore.Authorization
@inject ConfirmDialogService ConfirmDialog
@attribute [Authorize]

<PageTitle>Clientes - FacturaVERIFACTU</PageTitle>

<div class="notion-content">

    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-people-fill"></i>
            </span>
            <div>
                <h1>Clientes</h1>
            </div>
        </div>
        <button class="btn-modern" @onclick="NuevoCliente">
            <i class="bi bi-plus-lg"></i> Nuevo Cliente
        </button>
    </div>

    @* Toolbar de búsqueda *@
    <div class="notion-toolbar" style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 10px; background: white; border: 1.5px solid #e0e0e0; border-radius: 10px; padding: 10px 16px; max-width: 420px; transition: all 0.2s;">
            <i class="bi bi-search" style="font-size: 15px; color: rgba(15,23,42,.40);"></i>
            <input @bind="searchText"
                   @bind:event="oninput"
                   @onkeyup="Buscar"
                   placeholder="Buscar por razón social, CIF..."
                   style="border: none !important; outline: none !important; background: transparent !important; width: 100%; font-size: 14px; color: #0f172a; box-shadow: none !important; padding: 0 !important; margin: 0 !important; border-radius: 0 !important;" />
        </div>
    </div>

    @* Contenido principal *@
    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando base de datos...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 12px; border: 1px solid rgba(239,68,68,.18); background-color: rgba(239,68,68,.10); color: #b91c1c; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
        </div>
    }
    else if (clientes == null || !clientes.Any())
    {
        <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
            <i class="bi bi-person-vcard" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
            <h4 style="font-weight: 600; margin-bottom: 8px;">No hay clientes</h4>
            <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">Empieza agregando tu primer cliente para facturar.</p>
            <button class="btn-modern-secondary" @onclick="NuevoCliente">Añadir cliente</button>
        </div>
    }
    else
    {
        <div class="notion-table-wrapper">
            <table class="notion-table">
                <thead>
                    <tr>
                        <th style="width: 35%; text-align: left;">RAZÓN SOCIAL</th>
                        <th style="width: 15%; text-align: left;">CIF / NIF</th>
                        <th style="width: 25%; text-align: left;">EMAIL</th>
                        <th style="width: 10%; text-align: center;">ESTADO</th>
                        <th style="width: 15%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cliente in clientes)
                    {
                        <tr class="@(cliente.Activo ? "" : "notion-row-inactive")">
                            <td style="max-width: 0;">
                                <div class="notion-cell-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @cliente.Nombre
                                </div>
                            </td>
                            <td>
                                <span class="notion-code-text">@cliente.NIF</span>
                            </td>
                            <td style="max-width: 0;">
                                <span style="color: rgba(15,23,42,.65); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">
                                    @(cliente.Email ?? "-")
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <span class="notion-badge @(cliente.Activo ? "active" : "inactive")">
                                    @(cliente.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td style="text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 6px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarCliente(cliente)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn delete" title="Eliminar"
                                            @onclick="() => EliminarCliente(cliente)">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 14px; color: rgba(15,23,42,.50); font-size: 12px;">
            <span>Total: @clientes.Count clientes</span>
        </div>
    }

</div>

@code {
    private List<ClienteDto> clientes = new();
    private string searchText = string.Empty;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    private readonly IReadOnlyList<DataTableColumn<ClienteDto>> columns =
    [
        new DataTableColumn<ClienteDto> { Header = "Razón social", Value = item => item.Nombre },
        new DataTableColumn<ClienteDto> { Header = "CIF/NIF", Value = item => item.NIF },
        new DataTableColumn<ClienteDto> { Header = "Email", Value = item => item.Email ?? "-" }
    ];

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await CargarClientesAsync();
    }

    private async Task CargarClientesAsync(string? search = null)
    {
        isLoading = true;
        errorMessage = string.Empty;

        var endpoint = string.IsNullOrWhiteSpace(search)
            ? "api/clientes"
            : $"api/clientes?search={Uri.EscapeDataString(search)}";

        var response = await ApiService.GetAsync<PaginatedResponseDto<ClienteDto>>(endpoint);
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los clientes.";
            clientes = new List<ClienteDto>();
        }
        else
        {
            clientes = response.Items;
        }

        isLoading = false;
    }

    private async Task Buscar()
    {
        await CargarClientesAsync(searchText);
    }

    private void NuevoCliente() => NavManager.NavigateTo("/clientes/nuevo");

    private void EditarCliente(ClienteDto cliente) => NavManager.NavigateTo($"/clientes/editar/{cliente.ClienteId}");

    private Task EliminarCliente(ClienteDto cliente)
    {
        var options = new ConfirmDialogOptions(
            "¿Eliminar cliente?",
            $"El cliente {cliente.Nombre} se borrará permanentemente.",
            "Eliminar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            var result = await ApiService.DeleteAsyncDetailed($"api/clientes/{cliente.ClienteId}");

            if (!result.Success)
            {
                var message = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "No se puede eliminar el cliente."
                    : result.ErrorMessage;

                throw new InvalidOperationException(message);
            }

            await CargarClientesAsync(searchText);
            await InvokeAsync(StateHasChanged);
        });

        return Task.CompletedTask;
    }
}
