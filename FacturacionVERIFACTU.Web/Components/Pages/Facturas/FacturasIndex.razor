@page "/facturas"
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject ConfirmDialogService ConfirmDialog
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Facturas - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-receipt"></i>
            </span>
            <div>
                <h1>Facturas</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevaFactura">
            <i class="bi bi-receipt"></i>Nueva Factura
        </button>
    </div>

    
    @* Tabs de estado como Presupuestos *@
    <div class="notion-toolbar" style="border-bottom: 1px solid #edeceb; margin-bottom: 24px;">
    <div class="notion-tabs">
        @foreach (var tab in estadosTabs)
        {
            <button class="btn-modern-secondary @(tab.Estado == estadoSeleccionado ? "active" : string.Empty)"
                    @onclick="() => CambiarEstadoTab(tab.Estado)">
                <span>@tab.Etiqueta</span>
                <span class="tab-count">@ObtenerConteo(tab.Estado)</span>
            </button>
        }
    </div>
</div>

    @* Barra de acciones masivas *@
    @* Barra de acciones - Solo visible cuando hay selección Y facturas en ese estado permiten acciones *@
@if (seleccionados.Any())
    {
        <div class="notion-toolbar" style="margin-bottom: 24px;">
            <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
                <div class="notion-input-group">
                    <span style="font-weight: 600;">@seleccionados.Count seleccionado(s)</span>
                </div>
                @if (PuedenEnviarseAVerifactu())
                {
                    <div class="notion-input-group">
                    <button class="btn-modern" @onclick="EnviarMasivoAVerifactu">
                        <i class="bi bi-send"></i> Enviar a VeriFactu
                    </button>
                    </div>
                }
                @if (PuedenMarcarseComoPagadas())
                {
                    <div class="notion-input-group">
                    <button class="btn-modern" @onclick="MarcarMasivoComoPagadas">
                        <i class="bi bi-cash"></i> Pagadas
                    </button>
                    </div>
                }
                @if (seleccionados.Any())
                {
                    <div class="notion-input-group">
                    <button class="btn-modern-secondary" @onclick="DescargarPDFsMasivo">
                        <i class="bi bi-file-pdf"></i> Descargar PDFs
                    </button>
                    </div>
                }

            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando Facturas...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
        </div>
    }
    else if (facturasAMostrar == null || !facturasAMostrar.Any())
    {
        <div style="text-align: center; padding: 80px 20px; color: rgba(55, 53, 47, 0.4);">
            <i class="bi bi-receipt" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
            <h4 style="font-weight: 600; margin-bottom: 8px;">No hay facturas</h4>
            <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">Crea tu primera factura</p>
            <button class="btn-modern-secondary" @onclick="NuevaFactura">Crear factura</button>
        </div>
    }
    else
    {
        <div class="notion-table-wrapper">
            <table class="notion-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--notion-border);">
                        <th style="padding: 12px 16px; width: 4%; text-align: center;">
                            <input type="checkbox" @onchange="ToggleSeleccionarTodos" checked="@TodosSeleccionados" />
                        </th>
                        <th style="padding: 12px 16px; width: 20%; text-align: left;">Número</th>
                        <th style="padding: 12px 16px; width: 14%; text-align: left;">Fecha</th>
                        <th style="padding: 12px 16px; width: 24%; text-align: left;">Cliente</th>
                        <th style="padding: 12px 16px; width: 17%; text-align: right;">Total</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: left;">Estado</th>
                        <th style="padding: 12px 16px; width: 5%; text-align: left;">VeriFactu</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: left;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var factura in facturasAMostrar)
                    {
                       <tr>
                           <td style="padding: 16px; text-align: center;">
                                <input type="checkbox"
                                       checked="@seleccionados.Contains(factura.Id)"
                                       @onchange="(e) => ToggleSeleccion(factura, e)" />
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@factura.SerieCodigo-@factura.Numero</div>
                                <div class="notion-cell-desc">Ejercicio @factura.Ejercicio</div>
                            </td>
                            <td style="padding: 16px;">
                                <span style="color: #787774; font-size: 14px;">@factura.FechaEmision.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td style="padding: 16px;">
                                        <div class="notion-cell-title">@factura.ClienteNombre</div>
                            </td>
                            
                        
                    
                             <td style="padding: 16px; text-align: right;">
                                <span style="font-weight: 600;">@factura.Total.ToString("C")</span>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="notion-badge-@GetEstadoClass(factura.Estado)">@factura.Estado</span>
                            </td>
                    
                            <td style="padding: 16px; text-align: center;">
                                @if (factura.EnviadaVERIFACTU)
                                {
                                    <span class="notion-badge" style="background: #dcfce7; color: #166534;">
                                        <i class="bi bi-check-circle-fill"></i> Enviada
                                    </span>
                                }
                                else
                                {
                                    <span class="notion-badge" style="background: #fef3c7; color: #92400e;">
                                        <i class="bi bi-clock"></i> Pendiente
                                    </span>
                                }
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                    @if (!factura.Bloqueada && factura.Estado != "Anulada")
                                    {
                                        <button class="notion-action-btn" @onclick="() => EditarFactura(factura.Id)" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    }
                                    <button class="notion-action-btn" @onclick="() => DescargarPDF(factura.Id)" title="PDF">
                                        <i class="bi bi-file-pdf"></i>
                                    </button>
                                    @if (!factura.EnviadaVERIFACTU && factura.Estado != "Anulada")
                                    {
                                        <button class="notion-action-btn" style="color: #0ea5e9;" @onclick="() => EnviarAVerifactu(factura.Id)" title="Enviar VeriFactu">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    }
                                    @if (factura.Estado != "Anulada" && !factura.Bloqueada)
                                    {
                                        <button class="notion-action-btn delete" @onclick="() => AnularFactura(factura.Id)" title="Anular">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                    @if (factura.Estado == "Emitida")
                                    {
                                        <button class="notion-action-btn" style="color: #16a34a;" @onclick="() => MarcarComoPagada(factura.Id)" title="Marcar como pagada">
                                            <i class="bi bi-cash"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                     </tr> 
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
            <span>Mostrando @facturasAMostrar.Count facturas</span>
        </div>
    }
</div>

@code {
    [Inject] private IJSRuntime JS { get; set; } = null!;
    [Inject] private HttpClient Http { get; set; } = null!;

    private List<FacturaResponseDto> todasFacturas = new();
    private List<ClienteDto> clientes = new();
    private bool isLoading = true;
    private string? errorMessage;

    private int clienteIdFiltro = 0;
    private string filtroEstado = string.Empty;
    private string filtroTipoFactura = string.Empty;

    private List<FacturaResponseDto> facturasAMostrar => todasFacturas
         .Where(f =>
        (clienteIdFiltro == 0 || f.ClienteId == clienteIdFiltro) &&
        (string.IsNullOrEmpty(estadoSeleccionado) || f.Estado == estadoSeleccionado) &&
        (string.IsNullOrEmpty(filtroTipoFactura) || f.TipoFacturaVERIFACTU == filtroTipoFactura))
    .ToList();

    private string? estadoSeleccionado = null;

    private HashSet<int> seleccionados = new();

    private readonly List<EstadoTab> estadosTabs = new()
    {
        new("Todas", null),
        new("Emitidada", "Emitida"),
        new("Pagada", "Pagada"),
        new("Anulada", "Anulada")
    };

    private sealed record EstadoTab (string Etiqueta, string? Estado);

    private bool TodosSeleccionados => facturasAMostrar.Any() && facturasAMostrar.All(f => seleccionados.Contains(f.Id));

    protected override async Task OnInitializedAsync()
    {
        await CargarClientesAsync();
        await CargarFacturasAsync();
    }

    private async Task CargarClientesAsync()
    {
        try
        {
            var response = await ApiService.GetAsync<PaginatedResponseDto<ClienteDto>>("api/clientes?page=1&pageSize=500");
            clientes = response?.Items ?? new List<ClienteDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando clientes: {ex.Message}");
            clientes = new List<ClienteDto>();
        }
    }

    private async Task CargarFacturasAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            todasFacturas = await ApiService.GetAsync<List<FacturaResponseDto>>("api/facturas") ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar facturas: {ex.Message}";
            todasFacturas = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetEstadoClass(string estado) => estado.ToLower() switch
    {
        "emitida" => "estado-emitida",
        "pagada" => "estado-pagada",
        "anulada" => "estado-anulada",
        _ => ""
    };

    private string GetTipoFacturaClass(string tipo) => tipo.ToLower() switch
    {
        "f1" => "tipo-f1",
        "f2" => "tipo-f2",
        "f3" or "r1" or "r2" or "r3" or "r4" => "tipo-rectificativa",
        _ => ""
    };

    private void VerFactura(int id) => Navigation.NavigateTo($"/facturas/ver/{id}");

    private void EditarFactura(int id) => Navigation.NavigateTo($"/facturas/editar/{id}");

    private void NuevaFactura()
    {
        Navigation.NavigateTo("/facturas/nuevo");
    }

    private void CambiarEstadoTab(string? estado)
    {
        estadoSeleccionado = estado;
        seleccionados.Clear();
    }

    private int ObtenerConteo(string? estado)
    {
        if (string.IsNullOrWhiteSpace(estado))
            return todasFacturas.Count();
        return todasFacturas.Count(f => f.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase));
    }

    private void ToggleSeleccion(FacturaResponseDto factura,ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
            seleccionados.Add(factura.Id);
        else
            seleccionados.Remove(factura.Id);
    }

    private void ToggleSeleccionarTodos(ChangeEventArgs args)
    {
        if(args.Value is bool isChecked && isChecked)
        {
            foreach (var factura in facturasAMostrar)
                seleccionados.Add(factura.Id);
        }
        else
        {
            seleccionados.Clear();
        }
    }

    private async Task DescargarPDF(int id)
    {
        try
        {
            // Implementar descarga de PDF
            Console.WriteLine($"Descargar PDF de factura {id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al descargar PDF: {ex.Message}";
        }
    }

    private async Task EnviarAVerifactu(int id)
    {
        var options = new ConfirmDialogOptions(
            "Enviar a VeriFactu",
            "¿Deseas enviar esta factura a VeriFactu? Esta acción registrará la factura en el sistema de la AEAT.",
            "Enviar",
            "Cancelar");

        ConfirmDialog.Show(options, async () =>
        {
            try
            {
                await ApiService.PostAsync<object, object>($"api/facturas/{id}/enviar-verifactu", new { });
                await CargarFacturasAsync();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                errorMessage = $"Error al enviar a VeriFactu: {ex.Message}";
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private async Task AnularFactura(int id)
    {
        var options = new ConfirmDialogOptions(
            "Anular factura",
            "¿Estás seguro de que deseas anular esta factura? Esta acción no se puede deshacer.",
            "Sí, anular",
            "Cancelar");

        ConfirmDialog.Show(options, async () =>
        {
            try
            {
                // Implementar anulación
                Console.WriteLine($"Anular factura {id}");
                await CargarFacturasAsync();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                errorMessage = $"Error al anular factura: {ex.Message}";
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private void MarcarComoPagada(int id)
{
    var options = new ConfirmDialogOptions(
        "Marcar como pagada",
        "¿Deseas marcar esta factura como pagada?",
        "Marcar",
        "Cancelar"
    );

    ConfirmDialog.Show(options, async () =>
    {
        try
        {
            var factura = todasFacturas.FirstOrDefault(f => f.Id == id);
            if (factura == null) return;

            var dto = new MarcarComoPagadaDto 
            { 
                FechaPago = DateTime.Now,
                Importe = factura.Total,
                FormaPago = "Transferencia"
            };
            
            // ⭐ CAMBIO: Usar PatchAsync en lugar de PostAsync
            await ApiService.PatchAsync<MarcarComoPagadaDto, FacturaResponseDto>($"api/facturas/{id}/marcar-pagada", dto);
            await CargarFacturasAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al marcar como pagada: {ex.Message}";
            await InvokeAsync(StateHasChanged);
        }
    });
}

   private bool PuedenEnviarseAVerifactu()
        {
            if (!seleccionados.Any()) return false;
            var facturasSeleccionadas = facturasAMostrar.Where(f => seleccionados.Contains(f.Id));
            return facturasSeleccionadas.All(f => !f.EnviadaVERIFACTU && f.EnviadaVERIFACTU == false);
        }

        private bool PuedenMarcarseComoPagadas()
        {
            if (!seleccionados.Any()) return false;
            var facturasSeleccionadas = facturasAMostrar.Where(f => seleccionados.Contains(f.Id));
            return facturasSeleccionadas.All(f => f.Estado == "Emitida");
        }



    private void EnviarMasivoAVerifactu()
    {
        var options = new ConfirmDialogOptions(
            $"Enviar {seleccionados.Count} factura(s) a VeriFactu",
            "¿Deseas enviar las facuras seleccionadas a VeriFActu? Esta accion registrara las facturas en el sistema de AEAT",
            "Enviar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            errorMessage = string.Empty;
            var errores = new List<string>();

            foreach (var facturaId in seleccionados.ToList())
            {
                try
                {
                    await ApiService.PostAsync<object, object>($"api/facturas/{facturaId}/enviar-verifactu", new { });
                }
                catch (Exception ex)
                {
                    errores.Add($"Factura {facturaId}: {ex.Message}");
                }
            }

            if (errores.Any())
            {
                errorMessage = $"Algunas facturas no se enviaron: {string.Join(",", errores)}";
            }

            seleccionados.Clear();
            await CargarFacturasAsync();
            await InvokeAsync(StateHasChanged);
        });
    }

    private void MarcarMasivoComoPagadas()
    {
        var options = new ConfirmDialogOptions(
            $"Marcar {seleccionados.Count} fatura(s) como pagadas",
            "¿Deseas marcar las facturas como seleccionadas como pagadas?",
            "Marcar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            errorMessage = string.Empty;
            var errores = new List<string>();

            foreach (var facturaId in seleccionados.ToList())
            {
                try
                {
                    var dto = new MarcarComoPagadaDto
                        {
                            FechaPago = DateTime.Now,
                            Importe = todasFacturas.First(f => f.Id == facturaId).Total,
                            FormaPago = "Transferencia"
                        };
                    // Dentro del foreach, cambia:
                    await ApiService.PatchAsync<MarcarComoPagadaDto, FacturaResponseDto>($"api/facturas/{facturaId}/marcar-pagada", dto);
                }
                catch (Exception ex)
                {
                    errores.Add($"Factura {facturaId}: {ex.Message}");
                }
            }

            if (errores.Any())
            {
                errorMessage = $"Algunas facturas no se marcaron: {string.Join(",", errores)}";
            }

            seleccionados.Clear();
            await CargarFacturasAsync();
            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task DescargarPDFsMasivo()
    {


        var options = new ConfirmDialogOptions(
            $"Descargar {seleccionados.Count} fatura(s) en PDF",
            "¿Deseas descargar las facturas en PDF?",
            "Descargar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
            {
                errorMessage = string.Empty;
                var errores = new List<string>();
                foreach (var facturaId in seleccionados.ToList())
                {
                    try
                    {
                        var response = await Http.GetAsync($"api/facturas/{facturaId}/pdf");

                        if (!response.IsSuccessStatusCode) return;

                        var fileBytes = await response.Content.ReadAsByteArrayAsync();
                        var fileName = $"Factura_{facturaId}.pdf";

                        var base64 = Convert.ToBase64String(fileBytes);
                        await JS.InvokeVoidAsync("downloadFile", fileName, base64);
                    }
                    catch (Exception ex)
                    {
                        errores.Add($"Factura {facturaId}: {ex.Message}");
                    }
                }

                if (errores.Any())
                {
                    errorMessage = $"Algunas facturas no se marcaron: {string.Join(",", errores)}";
                }

                seleccionados.Clear();
                await CargarFacturasAsync();
                await InvokeAsync(StateHasChanged);
            });

    }

   
    
}