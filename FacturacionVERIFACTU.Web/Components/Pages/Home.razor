@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]

@inject IApiService ApiService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Dashboard - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">

    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-speedometer2"></i>
            </span>
            <div style="min-width:0;">
                <h1>Dashboard</h1>
                <div style="color: var(--muted); font-size: 14px;">
                    Gestión centralizada de VeriFactu
                </div>
            </div>
        </div>

        <div class="dash-controls">
            <select class="notion-input-modern" style="width: 140px;" @bind="SelectedYear" disabled="@isLoading">
                @foreach (var y in years)
                {
                    <option value="@y">@y</option>
                }
            </select>

            <button class="btn-modern-secondary" @onclick="ReloadAll" disabled="@isLoading">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Accesos rápidos -->
    <div class="dash-shortcuts">
        <a href="/facturas" class="dash-shortcut">
            <div class="dash-icon blue"><i class="bi bi-receipt"></i></div>
            <div>
                <div class="dash-shortcut-title">Facturas</div>
                <p class="dash-shortcut-desc">Emisión y control VeriFactu</p>
            </div>
        </a>

        <a href="/presupuestos" class="dash-shortcut">
            <div class="dash-icon orange"><i class="bi bi-file-earmark-text"></i></div>
            <div>
                <div class="dash-shortcut-title">Presupuestos</div>
                <p class="dash-shortcut-desc">Propuestas, estados y conversión</p>
            </div>
        </a>

        <a href="/albaranes" class="dash-shortcut">
            <div class="dash-icon cyan"><i class="bi bi-truck"></i></div>
            <div>
                <div class="dash-shortcut-title">Albaranes</div>
                <p class="dash-shortcut-desc">Entregas y conversión a factura</p>
            </div>
        </a>

        <a href="/clientes" class="dash-shortcut">
            <div class="dash-icon green"><i class="bi bi-people"></i></div>
            <div>
                <div class="dash-shortcut-title">Clientes</div>
                <p class="dash-shortcut-desc">Gestión de clientes</p>
            </div>
        </a>

        <a href="/productos" class="dash-shortcut">
            <div class="dash-icon red"><i class="bi bi-box-seam"></i></div>
            <div>
                <div class="dash-shortcut-title">Productos</div>
                <p class="dash-shortcut-desc">Catálogo y precios</p>
            </div>
        </a>
    </div>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 12px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 16px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @error
        </div>
    }

    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando dashboard...</span>
        </div>
    }
    else
    {
        <!-- KPIs -->
        <div class="dashboard-kpi-grid">
            <div class="dashboard-kpi">
                <div class="dashboard-kpi-title">Facturación mes actual</div>
                <div class="dashboard-kpi-value">@FormatCurrency(resumen?.FacturacionMesActual ?? 0)</div>
                <div class="dashboard-kpi-hint">Facturas “Emitida” del mes (UTC)</div>
            </div>

            <div class="dashboard-kpi">
                <div class="dashboard-kpi-title">Facturas pendientes</div>
                <div class="dashboard-kpi-value">@((resumen?.FacturasPendientesPago ?? 0).ToString("N0"))</div>
                <div class="dashboard-kpi-hint">Estado = “Emitida”</div>
            </div>

            <div class="dashboard-kpi">
                <div class="dashboard-kpi-title">Presupuestos pendientes</div>
                <div class="dashboard-kpi-value">@((resumen?.PresupuestosPendientes ?? 0).ToString("N0"))</div>
                <div class="dashboard-kpi-hint">Borrador / Enviado</div>
            </div>

            <div class="dashboard-kpi">
                <div class="dashboard-kpi-title">Clientes activos</div>
                <div class="dashboard-kpi-value">@((resumen?.ClientesActivos ?? 0).ToString("N0"))</div>
                <div class="dashboard-kpi-hint">Con facturas últimos 6 meses</div>
            </div>
        </div>

        <!-- 2 columnas -->
        <div class="dash-two-cols">
            <div class="ui-card dash-panel">
                <div class="dash-panel-head">
                    <div>
                        <div class="dash-panel-title">Facturación mensual</div>
                        <p class="dash-panel-subtitle">@selectedYear · no anuladas</p>
                    </div>
                </div>

                @if (facturacionMensual?.Count > 0)
                {
                    <div class="mini-bars">
                        @{
                            var max = facturacionMensual.Max(x => x.Total);
                            foreach (var m in facturacionMensual.OrderBy(x => x.NumeroMes))
                            {
                                var pct = max <= 0 ? 0 : (double)(m.Total / max) * 100.0;
                                <div class="mini-bar-row" title="@m.Mes: @FormatCurrency(m.Total) · @m.CantidadFacturas facturas">
                                    <div class="mini-bar-label">@MesCorto(m.NumeroMes)</div>
                                    <div class="mini-bar-track">
                                        <div class="mini-bar-fill" style="width:@pct.ToString("0.##")%"></div>
                                    </div>
                                    <div class="mini-bar-value">@FormatCurrency(m.Total)</div>
                                </div>
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="notion-empty">Sin datos.</div>
                }
            </div>

            <div class="ui-card dash-panel">
                <div class="dash-panel-head">
                    <div>
                        <div class="dash-panel-title">Comparativa anual</div>
                        <p class="dash-panel-subtitle">@comparativa?.YearAnterior vs @comparativa?.YearActual</p>
                    </div>
                </div>

                @if (comparativa is not null && comparativa.DatosActual?.Count == 12 && comparativa.DatosAnterior?.Count == 12)
                {
                    <div class="notion-table-wrapper">
                        <table class="notion-table">
                            <thead>
                                <tr>
                                    <th>Mes</th>
                                    <th style="text-align:right;">@comparativa.YearAnterior</th>
                                    <th style="text-align:right;">@comparativa.YearActual</th>
                                    <th style="text-align:right;">Δ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < 12; i++)
                                {
                                    var prev = comparativa.DatosAnterior[i];
                                    var curr = comparativa.DatosActual[i];
                                    var delta = curr - prev;

                                    <tr>
                                        <td>@MesCorto(i + 1)</td>
                                        <td style="text-align:right;">@FormatCurrency(prev)</td>
                                        <td style="text-align:right;">@FormatCurrency(curr)</td>
                                        <td style="text-align:right;">
                                            <span style="font-weight:800; color:@(delta >= 0 ? "#166534" : "#b91c1c");">
                                                @FormatCurrency(delta)
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="notion-empty">Sin datos.</div>
                }
            </div>
        </div>

        <!-- Top clientes / productos -->
        <div class="dash-two-cols">
            <div class="ui-card dash-panel">
                <div class="dash-panel-head">
                    <div>
                        <div class="dash-panel-title">Top clientes</div>
                        <p class="dash-panel-subtitle">@selectedYear · por total facturado</p>
                    </div>
                </div>

                @if (clientesTop?.Count > 0)
                {
                    <div class="notion-table-wrapper">
                        <table class="notion-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>NIF</th>
                                    <th style="text-align:right;">Total</th>
                                    <th style="text-align:right;">#</th>
                                    <th>Última</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in clientesTop)
                                {
                                    <tr>
                                        <td title="@c.RazonSocial" style="max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            @c.RazonSocial
                                        </td>
                                        <td class="notion-code-text" style="color:inherit;">@c.NIF</td>
                                        <td style="text-align:right;">@FormatCurrency(c.TotalFacturado)</td>
                                        <td style="text-align:right;">@c.CantidadFacturas</td>
                                        <td>@(c.UltimaFactura?.ToLocalTime().ToString("dd/MM/yyyy") ?? "-")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="notion-empty">Sin datos.</div>
                }
            </div>

            <div class="ui-card dash-panel">
                <div class="dash-panel-head">
                    <div>
                        <div class="dash-panel-title">Productos más vendidos</div>
                        <p class="dash-panel-subtitle">@selectedYear · por cantidad vendida</p>
                    </div>
                </div>

                @if (productosMasVendidos?.Count > 0)
                {
                    <div class="notion-table-wrapper">
                        <table class="notion-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th style="text-align:right;">Cantidad</th>
                                    <th style="text-align:right;">Total</th>
                                    <th style="text-align:right;">Precio medio</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in productosMasVendidos)
                                {
                                    <tr>
                                        <td title="@p.Nombre" style="max-width: 320px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            @p.Nombre
                                        </td>
                                        <td style="text-align:right;">@p.CantidadVendida.ToString("N2")</td>
                                        <td style="text-align:right;">@FormatCurrency(p.TotalFacturado)</td>
                                        <td style="text-align:right;">@FormatCurrency(p.PrecioMedio)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="notion-empty">Sin datos.</div>
                }
            </div>
        </div>

        <!-- Cobros -->
        <div class="ui-card dash-panel">
            <div class="dash-panel-head">
                <div>
                    <div class="dash-panel-title">Cobros</div>
                    <p class="dash-panel-subtitle">Facturado vs cobrado vs pendiente</p>
                </div>
            </div>

            @if (cobros is not null)
            {
                <div class="dashboard-kpi-grid" style="margin-top: 8px;">
                    <div class="dashboard-kpi">
                        <div class="dashboard-kpi-title">Total facturado</div>
                        <div class="dashboard-kpi-value">@FormatCurrency(cobros.TotalFacturado)</div>
                        <div class="dashboard-kpi-hint">No anuladas</div>
                    </div>

                    <div class="dashboard-kpi">
                        <div class="dashboard-kpi-title">Total cobrado</div>
                        <div class="dashboard-kpi-value">@FormatCurrency(cobros.TotalCobrado)</div>
                        <div class="dashboard-kpi-hint">Estado = “Pagada”</div>
                    </div>

                    <div class="dashboard-kpi">
                        <div class="dashboard-kpi-title">Total pendiente</div>
                        <div class="dashboard-kpi-value">@FormatCurrency(cobros.TotalPendiente)</div>
                        <div class="dashboard-kpi-hint">Estado = “Emitida”</div>
                    </div>

                    <div class="dashboard-kpi">
                        <div class="dashboard-kpi-title">Vencido</div>
                        <div class="dashboard-kpi-value">@FormatCurrency(cobros.TotalVencido)</div>
                        <div class="dashboard-kpi-hint">Vencidas</div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px;">
                    <span class="notion-badge inactive">Pagadas: @cobros.CantidadPagadas</span>
                    <span class="notion-badge inactive">Pendientes: @cobros.CantidadPendientes</span>
                    <span class="notion-badge inactive">Vencidas: @cobros.CantidadVencidas</span>
                </div>
            }
            else
            {
                <div class="notion-empty">Sin datos.</div>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private string? error;

    private int selectedYear;
    private List<int> years = new();

    private ResumenDashboardDto? resumen;
    private List<FacturacionMensualDto>? facturacionMensual;
    private List<ClienteTopDto>? clientesTop;
    private List<ProductoMasVendidoDto>? productosMasVendidos;
    private FacturacionComparativaDto? comparativa;
    private EstadisticasCobrosDto? cobros;

    protected override async Task OnInitializedAsync()
    {
        selectedYear = DateTime.Now.Year;
        years = Enumerable.Range(selectedYear - 4, 5).Reverse().ToList();
        await ReloadAll();
    }

    private int SelectedYear
    {
        get => selectedYear;
        set
        {
            if (selectedYear != value)
            {
                selectedYear = value;
                _ = ReloadYearScoped();
            }
        }
    }

    private async Task ReloadAll()
    {
        error = null;
        isLoading = true;

        try
        {
            resumen = await ApiService.GetAsync<ResumenDashboardDto>("api/dashboard/resumen");
            await ReloadYearScoped();
            comparativa = await ApiService.GetAsync<FacturacionComparativaDto>("api/dashboard/facturacion-comparativa");
            cobros = await ApiService.GetAsync<EstadisticasCobrosDto>("api/dashboard/estadisticas-cobros");
        }
        catch (Exception ex)
        {
            error = $"Error cargando dashboard: {ex.Message}";
            Console.WriteLine($"Error en ReloadAll: {ex}");
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ReloadYearScoped()
    {
        try
        {
            facturacionMensual = await ApiService.GetAsync<List<FacturacionMensualDto>>($"api/dashboard/facturacion-mensual?year={selectedYear}");
            clientesTop = await ApiService.GetAsync<List<ClienteTopDto>>($"api/dashboard/clientes-top?limit=5&year={selectedYear}");
            productosMasVendidos = await ApiService.GetAsync<List<ProductoMasVendidoDto>>($"api/dashboard/productos-mas-vendidos?limit=10&year={selectedYear}");
        }
        catch (Exception ex)
        {
            error = $"Error cargando datos del año: {ex.Message}";
            Console.WriteLine($"Error en ReloadYearScoped: {ex}");
        }
    }

    private static string MesCorto(int mes) => mes switch
    {
        1 => "Ene",
        2 => "Feb",
        3 => "Mar",
        4 => "Abr",
        5 => "May",
        6 => "Jun",
        7 => "Jul",
        8 => "Ago",
        9 => "Sep",
        10 => "Oct",
        11 => "Nov",
        12 => "Dic",
        _ => "-"
    };

    private static string FormatCurrency(decimal value) => value.ToString("C2");
}