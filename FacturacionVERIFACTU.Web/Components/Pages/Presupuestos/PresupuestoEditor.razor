@page "/presupuestos/nuevo"
@page "/presupuestos/editar/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@attribute [Authorize]

<div class="notion-content">
    <div class="notion-breadcrumb">
        <a href="/presupuestos">Presupuestos</a> / @(Id == 0 ? "Nuevo" : "Editar")
    </div>

    <div class="notion-page-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-file-earmark-text"></i>
            </span>
            <div>
                <h1>@(Id == 0 ? "Nuevo presupuesto" : $"Presupuesto {numeroPresupuesto}")</h1>
                <p>@(Id == 0 ? "Crea una propuesta comercial con líneas y totales automáticos." : $"Estado actual: {estadoPresupuesto}")</p>
            </div>
        </div>
    </div>

    <EditForm EditContext="editContext" OnValidSubmit="GuardarAsync" OnInvalidSubmit="OnInvalidSubmit" class="notion-form-container">
        <DataAnnotationsValidator />
        <ValidationSummary />

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
                <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(avisoImpuestos))
        {
            <div class="alert alert-warning" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff8e6; color: #8a6d3b; margin-bottom: 20px; padding: 12px;">
                <i class="bi bi-exclamation-triangle-fill"></i> @avisoImpuestos
            </div>
        }

        @if (!EsEditable && Id > 0)
        {
            <div class="alert alert-warning" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff9e6; color: #8a6d1f; margin-bottom: 20px; padding: 12px;">
                <i class="bi bi-info-circle-fill"></i> Solo se puede editar en estado Borrador.
            </div>
        }

        <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
            <div class="notion-input-group" style="grid-column: span 2;">
                <label class="notion-label">Cliente</label>
                <input class="notion-input-modern" placeholder="Filtrar clientes..." @bind="clienteFiltro" @bind:event="oninput" disabled="@(!EsEditable)" />
                <InputSelect @bind-Value="presupuesto.ClienteId" class="notion-input-modern" @onchange="OnClienteChanged" disabled="@(!EsEditable)">
                    <option value="0">Selecciona un cliente</option>
                    @foreach (var cliente in ClientesFiltrados)
                    {
                        <option value="@cliente.ClienteId">@cliente.Nombre (@cliente.NIF)</option>
                    }
                </InputSelect>
                @if (aplicaRecargoEquivalencia)
                {
                    <div class="notion-hint" style="margin-top: 6px; font-size: 12px; color: #8b8b8b;">
                        Cliente en régimen de recargo de equivalencia.
                    </div>
                }
            </div>

            <div class="notion-input-group">
                <label class="notion-label">Serie</label>
                <InputSelect @bind-Value="presupuesto.SerieId" class="notion-input-modern" disabled="@(Id > 0)">
                    <option value="0">Selecciona una serie</option>
                    @foreach (var serie in SeriesPresupuestos)
                    {
                        <option value="@serie.Id">@serie.Descripcion (@serie.Codigo) - @serie.Ejercicio)</option>
                    }
                </InputSelect>
            </div>

            <div class="notion-input-group">
                <label class="notion-label">Fecha emisión</label>
                <InputDate @bind-Value="presupuesto.FechaEmision" class="notion-input-modern" disabled="@(!EsEditable)" />
            </div>

            <div class="notion-input-group">
                <label class="notion-label">Fecha validez</label>
                <InputDate @bind-Value="presupuesto.FechaValidez" class="notion-input-modern" disabled="@(!EsEditable)" />
            </div>

            <div class="notion-input-group">
                <label class="notion-label">Retención (%)</label>
                <InputNumber TValue="decimal?"
                             Value="presupuesto.PorcentajeRetencion"
                             ValueChanged="@((decimal? v) => { presupuesto.PorcentajeRetencion = v; StateHasChanged(); })"
                             ValueExpression="() => presupuesto.PorcentajeRetencion"
                             class="notion-input-modern"
                             step="1.00"
                             min="0"
                             max="100"
                             disabled="@(!EsEditable)" />
            </div>

            <div class="notion-input-group" style="grid-column: span 3;">
                <label class="notion-label">Observaciones</label>
                <InputTextArea @bind-Value="presupuesto.Observaciones" class="notion-input-modern" rows="3" placeholder="Notas adicionales para el cliente" disabled="@(!EsEditable)" />
            </div>
        </div>

        <div class="presupuesto-lines-header">
            <div>
                <h3>Líneas del presupuesto</h3>
                <p style="color: rgba(55, 53, 47, 0.6); font-size: 13px; margin: 0;">
                    Añade productos o líneas manuales y revisa los importes en tiempo real.
                </p>
            </div>
            <div class="lines-actions">
                <button type="button" class="btn-modern-secondary" @onclick="AbrirModalProductosAsync" disabled="@(!EsEditable)">
                    <i class="bi bi-box-seam"></i> Añadir producto
                </button>
                <button type="button" class="btn-modern-secondary" @onclick="AgregarLineaManual" disabled="@(!EsEditable)">
                    <i class="bi bi-plus-circle"></i> Línea manual
                </button>
            </div>
        </div>

        <div class="notion-table-wrapper">
            <table class="notion-table" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--notion-border);">
                        <th style="padding: 12px 10px; width: 25%; text-align: left;">DESCRIPCIÓN</th>
                        <th style="padding: 12px 10px; width: 10%; text-align: right;">CANTIDAD</th>
                        <th style="padding: 12px 10px; width: 12%; text-align: right;">PRECIO</th>
                        <th style="padding: 12px 10px; width: 10%; text-align: right; white-space: nowrap;">DTO %</th>
                        <th style="padding: 12px 10px; width: 16%; text-align: right;">IMPUESTO</th>
                        <th style="padding: 12px 10px; width: 15%; text-align: right;">TOTAL</th>
                        <th style="padding: 12px 10px; width: 6%; text-align: center;">ACC.</th>
                    </tr>
                </thead>
                <tbody>
                    @if (presupuesto.Lineas.Count == 0)
                    {
                        <tr>
                            <td colspan="7" style="padding: 20px; text-align: center; color: rgba(55, 53, 47, 0.4);">
                                Añade líneas para calcular el presupuesto.
                            </td>
                        </tr>
                    }
                    else
                    {
                        var index = 0;
                        @foreach (var linea in presupuesto.Lineas)
                        {
                            var lineaActual = linea;
                            var lineaIndex = index++;
                            <tr key="@lineaIndex">
                                <td style="padding: 12px 10px;">
                                    <input type="text"
                                           class="notion-input-modern"
                                           placeholder="Descripción"
                                           value="@lineaActual.Descripcion"
                                           @onchange="@(e => { lineaActual.Descripcion = e.Value?.ToString() ?? string.Empty; })"
                                           disabled="@(!EsEditable)"
                                           style="font-size: 13px; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                           title="@lineaActual.Descripcion" />
                                    @if (!string.IsNullOrWhiteSpace(lineaActual.ArticuloCodigo))
                                    {
                                        <div class="notion-cell-desc" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@lineaActual.ArticuloCodigo">@lineaActual.ArticuloCodigo</div>
                                    }
                                </td>
                                <td style="padding: 12px 10px; text-align: right;">
                                    <input type="number"
                                           class="notion-input-modern"
                                           step="0.01"
                                           value="@lineaActual.Cantidad.ToString("0.##")"
                                           @onchange="@(e => { if (decimal.TryParse(e.Value?.ToString(), out var v)) lineaActual.Cantidad = v; })"
                                           disabled="@(!EsEditable)"
                                           style="text-align: right; font-size: 13px; width: 100%;" />
                                </td>
                                <td style="padding: 12px 10px; text-align: right;">
                                    <input type="number"
                                           class="notion-input-modern"
                                           step="0.01"
                                           value="@lineaActual.PrecioUnitario.ToString("0.##")"
                                           @onchange="@(e => { if (decimal.TryParse(e.Value?.ToString(), out var v)) lineaActual.PrecioUnitario = v; })"
                                           disabled="@(!EsEditable)"
                                           style="text-align: right; font-size: 13px; width: 100%;" />
                                </td>
                                <td style="padding: 12px 10px; text-align: right;">
                                    <input type="number"
                                           class="notion-input-modern"
                                           step="0.01"
                                           max="100"
                                           value="@lineaActual.PorcentajeDescuento.ToString("0.##")"
                                           @onchange="@(e => { if (decimal.TryParse(e.Value?.ToString(), out var v)) lineaActual.PorcentajeDescuento = v; })"
                                           disabled="@(!EsEditable)"
                                           style="text-align: right; font-size: 13px; width: 100%;" />
                                </td>
                                <td style="padding: 12px 10px; text-align: right;">
                                    <select class="notion-input-modern"
                                            value="@lineaActual.TipoImpuestoId"
                                            @onchange="@(e => { if (int.TryParse(e.Value?.ToString(), out var v)) { lineaActual.TipoImpuestoId = v; ActualizarImpuestoLinea(lineaActual); } })"
                                            disabled="@(!EsEditable)"
                                            style="font-size: 13px; width: 100%;">
                                        <option value="">Selecciona</option>
                                        @foreach (var tipo in tiposImpuesto.Where(tipo => tipo.Activo))
                                        {
                                            <option value="@tipo.Id" title="@tipo.Nombre,@(tipo.PorcentajeRecargo.HasValue && tipo.PorcentajeRecargo.Value > 0 ? $" (IVA {tipo.PorcentajeIva:N2}% + RE {tipo.PorcentajeRecargo.Value:N2}%)" : "")">
                                                IVA @tipo.PorcentajeIva.ToString("N0")%
                                            </option>
                                        }
                                    </select>
                                </td>
                                <td style="padding: 12px 10px; text-align: right;">
                                    <span style="font-weight: 600; font-size: 14px; white-space: nowrap;">@CalcularTotalLinea(lineaActual).ToString("C")</span>
                                </td>
                                <td style="padding: 12px 10px; text-align: center;">
                                    <button type="button"
                                            class="notion-action-btn delete"
                                            disabled="@(!EsEditable)"
                                            @onclick="@(() => EliminarLineaAsync(lineaActual))">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="presupuesto-totales">
            <div class="totales-item">
                <span>Base imponible</span>
                <strong>@TotalBaseImponible.ToString("C")</strong>
            </div>
            <div class="totales-item">
                <span>IVA</span>
                <strong>@TotalIVA.ToString("C")</strong>
            </div>
            @if (aplicaRecargoEquivalencia)
            {
                <div class="totales-item">
                    <span>Recargo equivalencia</span>
                    <strong>@TotalRecargo.ToString("C")</strong>
                </div>
            }
            <div class="totales-item">
                <span>Retención</span>
                <strong>-@TotalRetencion.ToString("C")</strong>
            </div>
            <div class="totales-item highlight">
                <span>Total</span>
                <strong>@TotalConRetencion.ToString("C")</strong>
            </div>
        </div>

        <div class="notion-form-actions" style="display: flex; gap: 12px; margin-top: 30px; border-top: 1px solid #edeceb; padding-top: 25px;">
            <button type="submit" class="btn-modern" style="min-width: 140px;" disabled="@(isSaving || !EsEditable)">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                else
                {
                    <span>Guardar</span>
                }
            </button>

            <button type="button" class="btn-modern-secondary" style="min-width: 140px;" @onclick="Cancelar">
                Cancelar
            </button>
        </div>
    </EditForm>

    @if (Id > 0)
    {
        <div class="convertir-factura" style="margin-top: 24px;">
            <h3>Cambiar estado del presupuesto</h3>
            <p>Estado actual: <strong>@estadoPresupuesto</strong></p>

            <div class="notion-form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 16px;">
                @if (estadoPresupuesto == "Borrador")
                {
                    <button class="btn-modern-secondary"
                            @onclick='() => CambiarEstadoAsync("Enviado")'
                            disabled="@isCambiandoEstado">
                        <i class="bi bi-send"></i> Marcar como Enviado
                    </button>
                }

                @if (estadoPresupuesto == "Enviado")
                {
                    <button class="btn-modern"
                            @onclick='() => CambiarEstadoAsync("Aceptado")'
                            disabled="@isCambiandoEstado"
                            style="background-color: #28a745; border-color: #28a745;">
                        <i class="bi bi-check-circle"></i> Marcar como Aceptado
                    </button>
                    <button class="btn-modern-secondary"
                            @onclick='() => CambiarEstadoAsync("Rechazado")'
                            disabled="@isCambiandoEstado"
                            style="background-color: #dc3545; border-color: #dc3545; color: white;">
                        <i class="bi bi-x-circle"></i> Marcar como Rechazado
                    </button>
                    <button class="btn-modern-secondary"
                            @onclick='() => CambiarEstadoAsync("Borrador")'
                            disabled="@isCambiandoEstado">
                        <i class="bi bi-arrow-counterclockwise"></i> Volver a Borrador
                    </button>
                }

                @if (estadoPresupuesto == "Rechazado")
                {
                    <button class="btn-modern-secondary"
                            @onclick='() => CambiarEstadoAsync("Borrador")'
                            disabled="@isCambiandoEstado">
                        <i class="bi bi-arrow-counterclockwise"></i> Volver a Borrador
                    </button>
                }
            </div>

            @if (isCambiandoEstado)
            {
                <div style="margin-top: 12px; color: #6c757d; font-size: 13px;">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                    Cambiando estado...
                </div>
            }
        </div>
    }

    @if (Id > 0 && estadoPresupuesto == "Aceptado")
    {
        <div class="convertir-factura">
            <h3>Convertir a factura</h3>
            <p>Genera la factura desde este presupuesto aceptado.</p>

            <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="notion-input-group">
                    <label class="notion-label">Serie factura</label>
                    <InputSelect @bind-Value="conversionFactura.SerieId" class="notion-input-modern">
                        <option value="0">Selecciona una serie</option>
                        @foreach (var serie in SeriesFacturas)
                        {
                            <option value="@serie.Id">@serie.Descripcion (@serie.Codigo) - @serie.Ejercicio</option>
                        }
                    </InputSelect>
                </div>
                <div class="notion-input-group">
                    <label class="notion-label">Fecha emisión</label>
                    <InputDate @bind-Value="conversionFactura.FechaEmision" class="notion-input-modern" />
                </div>
                <div class="notion-input-group" style="grid-column: span 2;">
                    <label class="notion-label">Observaciones</label>
                    <InputTextArea @bind-Value="conversionFactura.Observaciones" class="notion-input-modern" rows="2" />
                </div>
            </div>

            <button class="btn-modern" style="margin-top: 12px;" @onclick="ConvertirAFacturaAsync" disabled="@isConverting">
                @if (isConverting)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                else
                {
                    <span><i class="bi bi-receipt"></i> Convertir a factura</span>
                }
            </button>

            @if (!string.IsNullOrEmpty(convertirMensaje))
            {
                <div class="alert alert-info" style="margin-top: 12px; font-size: 13px; border-radius: 8px; border: none; background-color: #f0f7ff; color: #1b64b0; padding: 12px;">
                    <i class="bi bi-info-circle"></i> @convertirMensaje
                </div>
            }
        </div>
    }

    @if (Id > 0 && estadoPresupuesto == "Aceptado")
    {
        <div class="convertir-factura" style="margin-top: 24px;">
            <h3>Convertir a albarán</h3>
            <p>Genera un albarán desde este presupuesto aceptado.</p>

            <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div class="notion-input-group">
                    <label class="notion-label">Serie albarán</label>
                    <InputSelect @bind-Value="conversionAlbaran.SerieId" class="notion-input-modern">
                        <option value="0">Selecciona una serie</option>
                        @foreach (var serie in SeriesAlbaranes)
                        {
                            <option value="@serie.Id">@serie.Descripcion (@serie.Codigo) - @serie.Ejercicio</option>
                        }
                    </InputSelect>
                </div>
                <div class="notion-input-group">
                    <label class="notion-label">Fecha emisión</label>
                    <InputDate @bind-Value="conversionAlbaran.FechaEmision" class="notion-input-modern" />
                </div>
                <div class="notion-input-group">
                    <label class="notion-label">Fecha entrega</label>
                    <InputDate @bind-Value="conversionAlbaran.FechaEntrega" class="notion-input-modern" />
                </div>
                <div class="notion-input-group">
                    <label class="notion-label">Dirección entrega</label>
                    <InputText @bind-Value="conversionAlbaran.DireccionEntrega" class="notion-input-modern" />
                </div>
                <div class="notion-input-group" style="grid-column: span 3;">
                    <label class="notion-label">Observaciones</label>
                    <InputTextArea @bind-Value="conversionAlbaran.Observaciones" class="notion-input-modern" rows="2" />
                </div>
            </div>

            <button class="btn-modern" style="margin-top: 12px;" @onclick="ConvertirAAlbaranAsync" disabled="@isConvertingAlbaran">
                @if (isConvertingAlbaran)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                else
                {
                    <span><i class="bi bi-truck"></i> Convertir a albarán</span>
                }
            </button>

            @if (!string.IsNullOrEmpty(convertirAlbaranMensaje))
            {
                <div class="alert alert-info" style="margin-top: 12px; font-size: 13px; border-radius: 8px; border: none; background-color: #f0f7ff; color: #1b64b0; padding: 12px;">
                    <i class="bi bi-info-circle"></i> @convertirAlbaranMensaje
                </div>
            }
        </div>
    }
</div>

@* Reemplazar el modal de productos en PresupuestoForm.razor *@

@if (mostrarModalProductos)
{
    <div class="notion-modal-overlay" @onclick="CerrarModalProductos">
        <div class="notion-modal-productos" @onclick:stopPropagation="true">
            <div class="notion-modal-header">
                <h3>Selecciona un producto</h3>
                <button type="button" class="notion-modal-close" @onclick="CerrarModalProductos" aria-label="Cerrar">×</button>
            </div>
            <div class="notion-modal-body">
                <div class="notion-search-wrapper" style="max-width: 100%; border: 1px solid #edeceb; margin-bottom: 16px;">
                    <i class="bi bi-search" style="font-size: 14px;"></i>
                    <input class="notion-search-input"
                           placeholder="Buscar producto"
                           value="@busquedaProducto"
                           @oninput="@(async (ChangeEventArgs e) => { busquedaProducto = e?.Value?.ToString() ?? string.Empty; await BuscarProductosAsync(); })" />
                </div>

                @if (cargandoProductos)
                {
                    <div class="notion-loading" style="padding: 40px; text-align: center;">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span style="margin-left: 10px;">Cargando productos...</span>
                    </div>
                }
                else if (productos == null || !productos.Any())
                {
                    <div class="notion-empty" style="padding: 40px; text-align: center; color: rgba(55, 53, 47, 0.5);">
                        No hay productos disponibles.
                    </div>
                }
                else
                {
                    <div style="overflow-x: auto;">
                        <table class="notion-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--notion-border);">
                                    <th style="padding: 12px 10px; text-align: left; font-size: 11px; color: rgba(55, 53, 47, 0.6); font-weight: 600; text-transform: uppercase;">Código</th>
                                    <th style="padding: 12px 10px; text-align: left; font-size: 11px; color: rgba(55, 53, 47, 0.6); font-weight: 600; text-transform: uppercase;">Descripción</th>
                                    <th style="padding: 12px 10px; text-align: right; font-size: 11px; color: rgba(55, 53, 47, 0.6); font-weight: 600; text-transform: uppercase;">Precio</th>
                                    <th style="padding: 12px 10px; text-align: right; font-size: 11px; color: rgba(55, 53, 47, 0.6); font-weight: 600; text-transform: uppercase;">Impuesto</th>
                                    <th style="padding: 12px 10px; text-align: center; font-size: 11px; color: rgba(55, 53, 47, 0.6); font-weight: 600; text-transform: uppercase;">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var producto in productos)
                                {
                                    <tr style="border-bottom: 1px solid #f1f1f0;">
                                        <td style="padding: 12px 10px; font-size: 14px;">
                                            <span class="notion-code-text">@producto.Codigo</span>
                                        </td>
                                        <td style="padding: 12px 10px; font-size: 14px;">@producto.Descripcion</td>
                                        <td style="padding: 12px 10px; text-align: right; font-size: 14px; font-weight: 600;">@producto.PrecioUnitario.ToString("C")</td>
                                        <td style="padding: 12px 10px; text-align: right; font-size: 13px; color: rgba(55, 53, 47, 0.7);">@ObtenerDescripcionImpuesto(producto)</td>
                                        <td style="padding: 12px 10px; text-align: center;">
                                            <button type="button" class="btn-modern-secondary" @onclick="() => AgregarLineaDesdeProducto(producto)">
                                                <i class="bi bi-plus-lg"></i> Añadir
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
}





@code {

    [Parameter] public int Id { get; set; }

    private EditContext? editContext;

    private PresupuestoFormModel presupuesto = new();
    private List<ClienteDto> clientes = new();
    private List<ProductoDto> productos = new();
    private List<TipoImpuestoListadoDto> tiposImpuesto = new();

    private List<SerieDto> SeriesPresupuestos = new();
    private List<SerieDto> SeriesFacturas = new();

    private List<SerieDto> SeriesAlbaranes = new();

    private string clienteFiltro = string.Empty;
    private string busquedaProducto = string.Empty;
    private bool mostrarModalProductos;
    private bool cargandoProductos;
    private bool isSaving;
    private bool isConverting;
    private bool isConvertingAlbaran;
    private string errorMessage = string.Empty;
    private string? avisoImpuestos;
    private string convertirMensaje = string.Empty;
    private string convertirAlbaranMensaje = string.Empty;
    private string numeroPresupuesto = "";
    private string estadoPresupuesto = "Borrador";
    private bool isCambiandoEstado;
    private string estadoNuevo = string.Empty;
    private string motivoCambioEstado = string.Empty;
    private bool aplicaRecargoEquivalencia;

    private ConversionFacturaModel conversionFactura = new();
    private ConversionAlbaranModel conversionAlbaran = new();

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    private bool EsEditable => Id == 0 || estadoPresupuesto == "Borrador";
    private IEnumerable<ClienteDto> ClientesFiltrados => string.IsNullOrWhiteSpace(clienteFiltro)
        ? clientes
        : clientes.Where(c =>
            c.Nombre.Contains(clienteFiltro, StringComparison.OrdinalIgnoreCase)
            || c.NIF.Contains(clienteFiltro, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        editContext ??= new EditContext(presupuesto);

        try
        {

            await Task.WhenAll(
                CargarTiposImpuestoAsync(),
                CargarClientesAsync(),
                CargarSeriesPresupuestosAsync(),
                CargarSeriesFacturasAsync(),
                CargarSeriesAlbaranesAsync());

            if (Id > 0)
            {
                await CargarPresupuestoAsync();
                ActualizarClienteRecargo();
            }
            else
            {
                presupuesto.Lineas = new List<LineaPresupuestoViewModel>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error inicializando componente: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task CargarClientesAsync()
    {
        var response = await ApiService.GetAsync<PaginatedResponseDto<ClienteDto>>("api/clientes?page=1&pageSize=500");
        clientes = response?.Items ?? new List<ClienteDto>();
    }

    private async Task CargarTiposImpuestoAsync()
    {
        tiposImpuesto = await ApiService.GetAsync<List<TipoImpuestoListadoDto>>("api/tiposimpuesto") ?? new List<TipoImpuestoListadoDto>();
    }

    private async Task CargarSeriesPresupuestosAsync()
    {
        var response = await ApiService.GetAsync<PaginatedResponseDto<SerieDto>>(
            "api/series?page=1&pageSize=100&tipoDocumento=PRESUPUESTO&soloActivas=true");
        SeriesPresupuestos = response?.Items ?? new List<SerieDto>();
    }

    private async Task CargarSeriesFacturasAsync()
    {
        var response = await ApiService.GetAsync<PaginatedResponseDto<SerieDto>>(
            "api/series?page=1&pageSize=100&tipoDocumento=FACTURA&soloActivas=true");
        SeriesFacturas = response?.Items ?? new List<SerieDto>();
    }

    private async Task CargarSeriesAlbaranesAsync()
    {
        var response = await ApiService.GetAsync<PaginatedResponseDto<SerieDto>>(
            "api/series?page=1&pageSize=100&tipoDocumento=ALBARAN&soloActivas=true");
        SeriesAlbaranes = response?.Items ?? new List<SerieDto>();
    }

    private async Task CargarPresupuestoAsync()
    {
        var response = await ApiService.GetAsync<PresupuestoResponseDto>($"api/presupuestos/{Id}");
        if (response == null)
        {
            errorMessage = "No se pudo cargar el presupuesto seleccionado.";
            return;
        }

        numeroPresupuesto = response.NumeroPresupuesto;
        estadoPresupuesto = response.Estado;

        presupuesto = new PresupuestoFormModel
        {
            ClienteId = response.ClienteId,
            SerieId = response.SerieId,
            FechaEmision = ConvertirALocal(response.FechaEmision) ?? DateTime.Today,
            FechaValidez = ConvertirALocal(response.FechaValidez),
            Observaciones = response.Observaciones,
            PorcentajeRetencion = response.PorcentajeRetencion,
            Lineas = response.Lineas
                .OrderBy(l => l.Orden)
                .Select(l => new LineaPresupuestoViewModel
                {
                    Id = l.Id,
                    Descripcion = l.Descripcion,
                    Cantidad = l.Cantidad,
                    PrecioUnitario = l.PrecioUnitario,
                    PorcentajeDescuento = l.PorcentajeDescuento,
                    IVA = l.IVA,
                    RecargoEquivalencia = l.RecargoEquivalencia,
                    TipoImpuestoId = l.TipoImpuestoId,
                    ArticuloId = l.ArticuloId,
                    ArticuloCodigo = l.ArticuloCodigo
                })
                .ToList()
        };

        editContext = new EditContext(presupuesto);
        AplicarConfiguracionCliente();
    }

    private Task OnClienteChanged(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value?.ToString(), out var clienteId))
        {
            presupuesto.ClienteId = clienteId;
            AplicarConfiguracionCliente();
            ActualizarClienteRecargo();
            StateHasChanged();
        }

        return Task.CompletedTask;
    }

    private void AplicarConfiguracionCliente()
    {
        var cliente = ObtenerClienteSeleccionado();
        if (cliente == null)
        {
            return;
        }

        if (Id == 0 && (!presupuesto.PorcentajeRetencion.HasValue || presupuesto.PorcentajeRetencion == 0))
        {
            presupuesto.PorcentajeRetencion = cliente.PorcentajeRetencionDefecto;
        }
        ActualizarRecargoLineas();
    }

    private ClienteDto? ObtenerClienteSeleccionado()
    {
        return clientes.FirstOrDefault(c => c.ClienteId == presupuesto.ClienteId);
    }

    private void ActualizarRecargoLineas()
    {
        var cliente = ObtenerClienteSeleccionado();
        if (cliente == null || !cliente.RegimenRecargoEquivalencia)
        {
            foreach (var linea in presupuesto.Lineas)
            {
                linea.RecargoEquivalencia = 0;
            }

            return;
        }

        foreach (var linea in presupuesto.Lineas)
        {
            if (linea.RecargoEquivalencia <= 0)
            {
                linea.RecargoEquivalencia = CalcularRecargoEquivalencia(linea.IVA ?? 0m);
            }
        }
    }

    private void RecalcularRecargo(LineaPresupuestoViewModel linea)
    {
        var cliente = ObtenerClienteSeleccionado();
        if (cliente == null || !cliente.RegimenRecargoEquivalencia)
        {
            linea.RecargoEquivalencia = 0;
            return;
        }

        linea.RecargoEquivalencia = CalcularRecargoEquivalencia(linea.IVA ?? 0m);
    }

    private async Task GuardarAsync()
    {
        if (!EsEditable)
        {
            errorMessage = "Solo se pueden editar presupuestos en estado Borrador.";
            return;
        }

        if (presupuesto.ClienteId == 0 || presupuesto.SerieId == 0)
        {
            errorMessage = "Selecciona cliente y serie antes de guardar.";
            return;
        }

        presupuesto.Lineas = presupuesto.Lineas
            .Where(linea => !string.IsNullOrWhiteSpace(linea.Descripcion) && linea.Cantidad > 0)
            .ToList();

        if (presupuesto.Lineas.Count == 0)
        {
            errorMessage = "Añade al menos una línea valida.";
            return;
        }

        isSaving = true;
        errorMessage = string.Empty;

        var lineas = presupuesto.Lineas.Select(MapLineaRequest).ToList();

        try
        {
            if (Id == 0)
            {
                var request = new PresupuestoCreateDto
                {
                    ClienteId = presupuesto.ClienteId,
                    SerieId = presupuesto.SerieId,
                    Fecha = ConvertirAUtc(presupuesto.FechaEmision),
                    FechaValidez = ConvertirAUtc(presupuesto.FechaValidez),
                    Observaciones = presupuesto.Observaciones,
                    PorcentajeRetencion = presupuesto.PorcentajeRetencion,
                    Lineas = lineas
                };

                var result = await ApiService.PostAsync<PresupuestoCreateDto, PresupuestoResponseDto>("api/presupuestos", request);
                if (result == null)
                {
                    errorMessage = "No se pudo crear el presupuesto.";
                    isSaving = false;
                    return;
                }
            }
            else
            {
                var request = new PresupuestoUpdateDto
                {
                    ClienteId = presupuesto.ClienteId,
                    FechaEmision = ConvertirAUtc(presupuesto.FechaEmision),
                    FechaValidez = ConvertirAUtc(presupuesto.FechaValidez),
                    Observaciones = presupuesto.Observaciones,
                    PorcentajeRetencion = presupuesto.PorcentajeRetencion,
                    Lineas = lineas
                };

                var result = await ApiService.PutAsync<PresupuestoUpdateDto, PresupuestoResponseDto>($"api/presupuestos/{Id}", request);
                if (result == null)
                {
                    errorMessage = "No se pudo actualizar el presupuesto.";
                    isSaving = false;
                    return;
                }
            }

            NavManager.NavigateTo("/presupuestos");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al guardar: {ex.Message}";
            isSaving = false;
        }
    }

    private Task OnInvalidSubmit(EditContext context)
    {
        errorMessage = "Corrige los errores del formulario antes de guardar.";
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task ConvertirAFacturaAsync()
    {
        if (Id == 0)
        {
            convertirMensaje = "Selecciona una serie para la factura.";
            return;
        }

        isConverting = true;
        convertirMensaje = string.Empty;

        try
        {
            var request = new ConvertirPresupuestoAFacturaDto
            {
                SerieId = conversionFactura.SerieId,
                FechaEmision = ConvertirAUtc(conversionFactura.FechaEmision),
                Observaciones = conversionFactura.Observaciones
            };

            var result = await ApiService.PostAsync<ConvertirPresupuestoAFacturaDto, FacturaResponseDto>($"api/facturas/desde-presupuesto/{Id}", request);
            if (result == null)
            {
                convertirMensaje = "No se pudo convertir el presupuesto a factura.";
            }
            else
            {
                convertirMensaje = $"Factura generada correctamente: {result.Numero ?? "sin número"}.";
                NavManager.NavigateTo($"/facturas/editar/{result.Id}");
            }
        }
        catch (Exception ex)
        {
            convertirMensaje = $"Error: {ex.Message}";
        }
        finally
        {
            isConverting = false;
        }
    }

    private async Task ConvertirAAlbaranAsync()
    {
        if (Id == 0)
        {
            convertirAlbaranMensaje = "Selecciona una serie para el albarán.";
            return;
        }

        isConvertingAlbaran = true;
        convertirAlbaranMensaje = string.Empty;

        try
        {
            var request = new ConvertirPresupuestoAAlbaranDto
            {
                SerieId = conversionAlbaran.SerieId,
                FechaEmision = ConvertirAUtc(conversionAlbaran.FechaEmision),
                FechaEntrega = ConvertirAUtc(conversionAlbaran.FechaEntrega),
                DireccionEntrega = conversionAlbaran.DireccionEntrega,
                Observaciones = conversionAlbaran.Observaciones
            };

            var result = await ApiService.PostAsync<ConvertirPresupuestoAAlbaranDto, AlbaranResponseDto>(
                $"api/albaranes/desde-prespuesto/{Id}", request);

            if (result == null)
            {
                convertirAlbaranMensaje = "No se pudo convertir el presupuesto a albarán.";
            }
            else
            {
                var numeroText = Convert.ToString(result.Numero) ?? "sin numero";
                convertirAlbaranMensaje = $"Albarán generado correctamente: {numeroText}.";
                NavManager.NavigateTo($"/albaranes/editar/{result.Id}");
            }
        }
        catch (Exception ex)
        {
            convertirAlbaranMensaje = $"Error: {ex.Message}";
        }
        finally
        {
            isConvertingAlbaran = false;
        }
    }

    private void Cancelar() => NavManager.NavigateTo("/presupuestos");

    private async Task CambiarEstadoAsync(string nuevoEstado)
    {
        if (Id == 0)
            return;

        var mensaje = nuevoEstado switch
        {
            "Enviado" => "¿Marcar el presupuesto como enviado al cliente?",
            "Aceptado" => "¿Marcar el presupuesto como aceptado?\n\nPodrás convertirlo a factura o albarán.",
            "Rechazado" => "¿Marcar presupuesto como rechazado?",
            "Borrador" => "¿Volver el presupuesto a estado Borrador?",
            _ => $"¿Cambiar estado a {nuevoEstado}?"
        };

        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", mensaje);
        if (!confirm)
            return;

        isCambiandoEstado = true;
        errorMessage = string.Empty;

        try
        {
            var request = new CambiarEstadoPresupuestoDto
            {
                NuevoEstado = nuevoEstado,
                Motivo = motivoCambioEstado
            };

            // Usar PATCH: el controlador expone [HttpPatch("{id}/estado")]
            var result = await ApiService.PatchAsync<CambiarEstadoPresupuestoDto, PresupuestoResponseDto>($"api/presupuestos/{Id}/estado", request);

            if (result == null)
            {
                errorMessage = "No se pudo cambiar el estado del presupuesto.";
            }
            else
            {
                estadoPresupuesto = result.Estado;
                motivoCambioEstado = string.Empty;
                // refrescar UI / recalcular permisos
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cambiar estado: {ex.Message}";
        }
        finally
        {
            isCambiandoEstado = false;
            StateHasChanged();
        }
    }

    private void AgregarLineaManual()
    {
        if (!EsEditable)
            return;

        presupuesto.Lineas.Add(CrearLineaConTipoPorDefecto());
    }

    private async Task EliminarLineaAsync(LineaPresupuestoViewModel linea)
    {
        if (!EsEditable)
        {
            return;
        }

        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "¿Eliminar esta línea del presupuesto?");
        if (!confirm)
        {
            return;
        }

        presupuesto.Lineas.Remove(linea);
        StateHasChanged();
    }

    private async Task AbrirModalProductosAsync()
    {
        mostrarModalProductos = true;
        await CargarProductosAsync();
    }

    private void CerrarModalProductos()
    {
        mostrarModalProductos = false;
    }

    private async Task CargarProductosAsync(string? search = null)
    {
        cargandoProductos = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var endpoint = string.IsNullOrWhiteSpace(search)
                ? "api/Productos?page=1&pageSize=100"
                : $"api/Productos?page=1&pageSize=100&search={Uri.EscapeDataString(search)}";

            var response = await ApiService.GetAsync<PaginatedResponseDto<ProductoDto>>(endpoint);
            productos = response?.Items ?? new List<ProductoDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando productos: {ex.Message}");
            productos = new List<ProductoDto>();
        }
        finally
        {
            cargandoProductos = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task BuscarProductosAsync()
    {
        await CargarProductosAsync(busquedaProducto);
    }

    private void AgregarLineaDesdeProducto(ProductoDto producto)
    {
        if (!EsEditable)
        {
            return;
        }

        var linea = new LineaPresupuestoViewModel
        {
            Descripcion = producto.Descripcion,
            Cantidad = 1,
            PrecioUnitario = producto.PrecioUnitario,
            PorcentajeDescuento = 0,
            IVA = producto.PorcentajeIva,
            ArticuloId = producto.ProductoId,
            ArticuloCodigo = producto.Codigo
        };

        if (producto.TipoImpuestoId.HasValue)
        {
            linea.TipoImpuestoId = producto.TipoImpuestoId;
            AplicarTipoImpuesto(linea);
        }
        else
        {
            var tipoDefault = ObtenerTipoImpuestoPorDefecto();
            if (tipoDefault != null)
            {
                linea.TipoImpuestoId = tipoDefault.Id;
                AplicarTipoImpuesto(linea);
                avisoImpuestos = $"El producto {producto.Codigo} no tiene tipo de impuesto asignado. Se aplicó {tipoDefault.Nombre} por defecto.";
            }
            else
            {
                avisoImpuestos = $"El producto {producto.Codigo} no tiene tipo de impuesto asignado.";
            }
        }

        presupuesto.Lineas.Add(linea);

        CerrarModalProductos();
        StateHasChanged();
    }

    private LineaPresupuestoDto MapLineaRequest(LineaPresupuestoViewModel linea)
    {
        return new LineaPresupuestoDto
        {
            Id = linea.Id,
            TipoImpuestoId = linea.TipoImpuestoId,
            Descripcion = linea.Descripcion,
            Cantidad = linea.Cantidad,
            PrecioUnitario = linea.PrecioUnitario,
            PorcentajeDescuento = linea.PorcentajeDescuento,
            IVA = linea.IVA,
            RecargoEquivalencia = linea.RecargoEquivalencia,
            ArticuloId = linea.ArticuloId
        };
    }

    private decimal CalcularSubtotal(LineaPresupuestoViewModel linea)
    {
        return linea.Cantidad * linea.PrecioUnitario;
    }

    private decimal CalcularDescuento(LineaPresupuestoViewModel linea)
    {
        return CalcularSubtotal(linea) * (linea.PorcentajeDescuento / 100m);
    }

    private decimal CalcularBase(LineaPresupuestoViewModel linea)
    {
        return CalcularSubtotal(linea) - CalcularDescuento(linea);
    }

    private decimal CalcularIVA(LineaPresupuestoViewModel linea)
    {
        return CalcularBase(linea) * ((linea.IVA ?? 0m) / 100m);
    }

    private decimal CalcularRecargo(LineaPresupuestoViewModel linea)
    {
        if (!aplicaRecargoEquivalencia)
        {
            return 0m;
        }

        return CalcularBase(linea) * ((linea.RecargoEquivalencia ?? 0m) / 100m);
    }

    private decimal CalcularTotalLinea(LineaPresupuestoViewModel linea)
    {
        return CalcularBase(linea) + CalcularIVA(linea) + CalcularRecargo(linea);
    }

    private decimal TotalBaseImponible => presupuesto.Lineas.Sum(CalcularBase);
    private decimal TotalIVA => presupuesto.Lineas.Sum(CalcularIVA);
    private decimal TotalRecargo => presupuesto.Lineas.Sum(CalcularRecargo);
    private decimal TotalPresupuesto => presupuesto.Lineas.Sum(CalcularTotalLinea);
    private decimal TotalRetencion => TotalBaseImponible * ((presupuesto.PorcentajeRetencion ?? 0m) / 100m);
    private decimal TotalConRetencion => TotalPresupuesto - TotalRetencion;

    private void ActualizarClienteRecargo()
    {
        var cliente = clientes.FirstOrDefault(c => c.ClienteId == presupuesto.ClienteId);
        aplicaRecargoEquivalencia = cliente?.RegimenRecargoEquivalencia ?? false;
        if (!aplicaRecargoEquivalencia)
        {
            return;
        }

        foreach (var linea in presupuesto.Lineas.Where(l => l.TipoImpuestoId.HasValue && !l.RecargoEquivalencia.HasValue))
        {
            AplicarTipoImpuesto(linea);
        }
    }

    private LineaPresupuestoViewModel CrearLineaConTipoPorDefecto()
    {
        var linea = new LineaPresupuestoViewModel();
        var tipoDefault = ObtenerTipoImpuestoPorDefecto();
        if (tipoDefault != null)
        {
            linea.TipoImpuestoId = tipoDefault.Id;
            AplicarTipoImpuesto(linea);
        }

        return linea;
    }

    private TipoImpuestoListadoDto? ObtenerTipoImpuestoPorDefecto()
    {
        return tiposImpuesto.FirstOrDefault(tipo =>
                tipo.Activo && tipo.Nombre.Equals("General", StringComparison.OrdinalIgnoreCase))
            ?? tiposImpuesto.FirstOrDefault(tipo => tipo.Activo);
    }

    private void ActualizarImpuestoLinea(LineaPresupuestoViewModel linea)
    {
        AplicarTipoImpuesto(linea);
    }

    private void AplicarTipoImpuesto(LineaPresupuestoViewModel linea)
    {
        if (!linea.TipoImpuestoId.HasValue)
        {
            return;
        }

        var tipo = tiposImpuesto.FirstOrDefault(t => t.Id == linea.TipoImpuestoId);
        if (tipo == null)
        {
            return;
        }

        linea.IVA = tipo.PorcentajeIva;
        linea.RecargoEquivalencia = aplicaRecargoEquivalencia
            ? tipo.PorcentajeRecargo ?? 0m
            : 0m;
    }

    private string ObtenerDescripcionImpuesto(ProductoDto producto)
    {
        if (producto.TipoImpuestoId.HasValue)
        {
            var tipo = tiposImpuesto.FirstOrDefault(t => t.Id == producto.TipoImpuestoId);
            if (tipo != null)
            {
                return $"{tipo.Nombre} ({tipo.PorcentajeIva:N2}% IVA)";
            }
        }

        return producto.PorcentajeIva.HasValue
             ? $"IVA {producto.PorcentajeIva.Value:N2}%"
             : "Sin asignar";
    }

    private static decimal CalcularRecargoEquivalencia(decimal iva)
    {
        return iva switch
        {
            21m => 5.2m,
            10m => 1.4m,
            4m => 0.5m,
            0m => 0m,
            _ => 0m
        };
    }

    private static DateTime? ConvertirAUtc(DateTime? value)
    {
        if (!value.HasValue)
        {
            return null;
        }

        var local = DateTime.SpecifyKind(value.Value, DateTimeKind.Local);
        return local.ToUniversalTime();
    }

    private static DateTime? ConvertirALocal(DateTime? value)
    {
        if (!value.HasValue)
        {
            return null;
        }

        if (value.Value.Kind == DateTimeKind.Utc)
        {
            return value.Value.ToLocalTime();
        }

        return value;
    }

    private sealed class PresupuestoFormModel
    {
        [Required]
        public int ClienteId { get; set; }

        [Required]
        public int SerieId { get; set; }

        [Required]
        public DateTime FechaEmision { get; set; } = DateTime.Today;

        public DateTime? FechaValidez { get; set; }

        [StringLength(500)]
        public string? Observaciones { get; set; }

        [Range(0, 100)]
        public decimal? PorcentajeRetencion { get; set; }

        public List<LineaPresupuestoViewModel> Lineas { get; set; } = new();
    }

    private sealed class LineaPresupuestoViewModel
    {
        public int? Id { get; set; }

        public int? TipoImpuestoId { get; set; }

        [Required]
        public string Descripcion { get; set; } = string.Empty;

        [Range(0.01, double.MaxValue)]
        public decimal Cantidad { get; set; } = 1;

        [Range(0, double.MaxValue)]
        public decimal PrecioUnitario { get; set; }

        [Range(0, 100)]
        public decimal PorcentajeDescuento { get; set; }

        [Range(0, 100)]
        public decimal? IVA { get; set; } = 21;

        public decimal? RecargoEquivalencia { get; set; }

        public int? ArticuloId { get; set; }

        public string? ArticuloCodigo { get; set; }
    }

    private sealed class ConversionFacturaModel
    {
        [Required]
        public int SerieId { get; set; } = 1;

        [Required]
        public DateTime FechaEmision { get; set; } = DateTime.Today;

        [MaxLength(500)]
        public string? Observaciones { get; set; }

    }

    private sealed class ConversionAlbaranModel
    {
        [Required]
        public int SerieId { get; set; } = 1;

        public DateTime? FechaEmision { get; set; } = DateTime.Today;

        public DateTime? FechaEntrega { get; set; }

        [MaxLength(200)]
        public string? DireccionEntrega { get; set; }

        [MaxLength(500)]
        public string? Observaciones { get; set; }
    }
}
