@page "/presupuestos"
@using Microsoft.AspNetCore.Authorization
@inject ConfirmDialogService confirmDialog
@attribute [Authorize]

<PageTitle>Presupuestos - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-file-earmark-text"></i>
            </span>
            <div>
                <h1>Presupuesto</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">
            <i class="bi bi-plus-lg"></i> Nuevo Presupuesto
        </button>
    </div>
</div>

    <div class="notion-toolbar" style="border-bottom: 1px solid #edecbd; margin-bottom 24px;">
        <div class="notion-tabs">
            @foreach (var estado in estadosDisponibles)
            {
                <button class="btn-modern-secondary @(estado.Valor == estadoSeleccionado ? "active" : string.Empty)"
                        @onclick="() => CambiarEstado(estado.Valor)">
                    <span>@estado.Etiqueta</span>
                    <span class="tab-count">@ObtenerConteo(estado.Valor)</span>
                </button>
            }
        </div>
    </div>


@*Barra de exportacion masiva*@
@if (seleccionados.Any())
{
    <div class="notion-toolbar" style="margin-bottom: 24px;">
        <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 12px;">
            <div class="notion-input-group">
                <span style="font-weight: 600;">@seleccionados.Count seleccionado(s)</span>
            </div>

            <div class="notion-input-group" style="display:flex; gap:8px; justify-content:flex-end; align-items:flex-end; flex-wrap:wrap;">
                @if(seleccionados.All(Id => presupuestos.First(p => p.Id == Id).Estado == "Borrador"))
                {
                    <div class="notion-input-group">
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => CambioEstadoMasivo("Enviado","Borrador")'>
                            <i class="bi bi-check-circle"></i> Marcar como Enviado
                        </button>
                    </div>
                }

                @if (seleccionados.All(Id => presupuestos.First(p => p.Id == Id).Estado == "Enviado"))
                {
                    <div class="notion-input-group">
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => CambioEstadoMasivo("Aceptado", "Enviado")'>
                            <i class="bi bi-check-circle"></i> Marcar como Aceptado
                        </button>
                    </div>
                    <div class="notion-input-group">
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => CambioEstadoMasivo("Rechazado", "Enviado")'>
                            <i class="bi bi-check-circle"></i> Marcar como Rechazado
                        </button>
                    </div>
                }
                @if (seleccionados.All(Id => presupuestos.First(p => p.Id == Id).Estado == "Rechazado"))
                {
                    <div class="notion-input-group">
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => CambioEstadoMasivo("Borrador", "Rechazado")'>
                            <i class="bi bi-check-circle"></i> Volver a borrador
                        </button>
                    </div>
                }

                @if (seleccionados.All(Id => presupuestos.First(p => p.Id == Id).Estado == "Aceptado"))
                {
                    <div class="notion-input-group bulk-serie" style="width:200px; min-width:180px;">
                        <label class="notion-label">Serie factura</label>
                        <InputSelect @bind-Value="conversionAgrupada.SerieId" class="notion-input-modern" style="margin-bottom:0;">
                            <option value="0">Selecciona serie</option>
                            @foreach (var serie in seriesFacturas)
                            {
                                <option value="@serie.Id">@serie.Descripcion (@serie.Codigo)</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="notion-input-group">
                        <button type="button" class="btn-modern bulk-btn" @onclick='() => ExportarFacturaAgrupadaAsync()'>
                            <i class="bi bi-check-circle"></i> Facturar
                        </button>
                    </div>
                }

                <button type="button" class="btn-modern-secondary bulk-btn" @onclick="DescargarPdfMasivo">
                    <i class="bi bi-trash"></i> Descargar Presupuestos
                </button>

                <button type="button" class="btn-modern-secondary bulk-btn" @onclick="EliminarSeleccionadosAsync">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>



        @if (!string.IsNullOrEmpty(conversionMessage))
        {
            <div class="alert alert-info" style="margin-top: 12px; font-size: 13px; border-radius: 8px; border: none; background-color: #f0f7ff; color: #1b64b0; padding: 12px;">
                <i class="bi bi-info-circle"></i> @conversionMessage
            </div>
        }
    </div>
}

@if (isLoading)
{
    <div class="notion-loading">
        <div class="spinner-modern"></div>
        <span>Cargando presupuestos ....</span>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
        <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
    </div>
}
else if(presupuestos == null || !presupuestos.Any())
{
    <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
        <i class="bi bi-file-earmark-text" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
        <h4 style="font-weight: 600; margin-bottom: 8px;">No hay presupuestos</h4>
        <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">
            Empieza creando tu primer presupuesto para formalizar propuestas.
        </p>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">Crear presupuesto</button>
    </div>
}
else
{
    {
        <div class="notion-table-wrapper">
            <table class="notion-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--notion-border);">
                        <th style="padding: 12px 16px; width: 4%; text-align: center;">
                            <input type="checkbox" @onchange="ToggleSeleccionarTodos" checked="@TodosSeleccionados" />
                        </th>
                        <th style="padding: 12px 16px; width: 18%; text-align: left;">NÚMERO</th>
                        <th style="padding: 12px 16px; width: 28%; text-align: left;">CLIENTE</th>
                        <th style="padding: 12px 16px; width: 16%; text-align: left;">EMISIÓN</th>
                        <th style="padding: 12px 16px; width: 14%; text-align: right;">TOTAL</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: center;">ESTADO</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var presupuesto in presupuestos)
                    {
                        <tr>
                            <td style="padding: 16px; text-align: center;">
                                <input type="checkbox" checked="@seleccionados.Contains(presupuesto.Id)" @onchange="(e) => ToggleSeleccion(presupuesto, e)" />
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.NumeroPresupuesto</div>
                                <div class="notion-cell-desc">Ejercicio @presupuesto.Ejercicio</div>
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.ClienteNombre</div>
                            </td>
                            <td style="padding: 16px;">
                                <span style="color: #787774; font-size: 14px;">@presupuesto.FechaEmision.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <span style="font-weight: 600;">@presupuesto.Total.ToString("C")</span>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="notion-badge-@ObtenerClaseEstado(presupuesto.Estado)">@presupuesto.Estado</span>
                                
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarPresupuesto(presupuesto)">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    @* Botones de cambio de estado *@
                                    @if (presupuesto.Estado == "Borrador")
                                    {
                                        <button class="notion-action-btn"
                                                title="Marcar como Enviado"
                                                @onclick='() => CambiarEstadoIndividual(presupuesto.Id, "Enviado")'>
                                            <i class="bi bi-send"></i>
                                        </button>
                                    }

                                    @if (presupuesto.Estado == "Enviado")
                                    {
                                        <button class="notion-action-btn"
                                                title="Marcar como Aceptado"
                                                @onclick='() => CambiarEstadoIndividual(presupuesto.Id, "Aceptado")'
                                                style="color: #28a745;">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button class="notion-action-btn"
                                                title="Marcar como Rechazado"
                                                @onclick='() => CambiarEstadoIndividual(presupuesto.Id, "Rechazado")'
                                                style="color: #dc3545;">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }

                                    @if(presupuesto.Estado == "Borrador")
                                    {
                                        <button class="notion-action-btn delete" title="Eliminar"
                                                disabled="@(presupuesto.Estado != "Borrador")"
                                                @onclick="() => EliminarPresupuesto(presupuesto)">
                                            <i class="bi bi-trash3"></i>
                                        </button>
                                    }

                                    <button class="notion-action-btn"
                                            title="Descargar PDF"
                                            @onclick="() => DescargarPDF(presupuesto.Id)">
                                        <i class="bi bi-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
            <span>Total: @presupuestos.Count presupuestos</span>
        </div>
}
}


@code {
    [Inject] private IJSRuntime JS { get; set; }
    [Inject] private HttpClient Http{ get; set; }

    private sealed record EstadoTab(string Etiqueta, string? Valor);

    private readonly IReadOnlyList<EstadoTab> estadosDisponibles =
    [
        new EstadoTab("Todos", null),
        new EstadoTab("Borrador", "Borrador"),
        new EstadoTab("Enviados", "Enviado"),
        new EstadoTab("Aceptados", "Aceptado"),
        new EstadoTab("Rechazados", "Rechazado")
    ];

    private List<PresupuestoResponseDto> presupuestos = new();
    private List<PresupuestoResponseDto> presupuestosTodos = new();
    private List<SerieDto> seriesFacturas = new();
    private readonly HashSet<int> seleccionados = new();
    private string? estadoSeleccionado;
    private bool isLoading = true;
    private bool isConverting;
    private string errorMessage = string.Empty;
    private string conversionMessage = string.Empty;

    private ConversionFacturaAgrupadaModel conversionAgrupada = new();

    [Inject] private IApiService ApiService { get; set; } = null;
    [Inject] private NavigationManager NavigationManager { get; set; } = null;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarPresupuestosAsync();
        await CargarSeriesFacturasAsync();
    }

    private async Task CargarPresupuestosAsync(string? estado = null)
    {
        isLoading = true;
        errorMessage = string.Empty;
        conversionMessage = string.Empty;

        var response = await ApiService.GetAsync<List<PresupuestoResponseDto>>("api/Presupuestos");
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los presupuestos";
            presupuestos = new List<PresupuestoResponseDto>();
            presupuestosTodos = new List<PresupuestoResponseDto>();
            seleccionados.Clear();
        }
        else
        {
            presupuestosTodos = response;
            presupuestos = FiltrarPresupuestos(estado);
            seleccionados.RemoveWhere(id => presupuestosTodos.All(p => p.Id != id));
        }

        isLoading = false;
    }

    private async Task CargarSeriesFacturasAsync()
    {
        var response = await ApiService.GetAsync<PaginatedResponseDto<SerieDto>>(
        "api/series?page=1&pageSize=100&tipoDocumento=FACTURA&soloActivas=true");
        seriesFacturas = response?.Items ?? new List<SerieDto>();
    }

    private string ObtenerClaseEstado(string estado) => estado switch
    {
        "Borrador" => "warning",
        "Enviados" => "info",
        "Aceptado" => "success",
        "Rechazado" => "error",
        _ => "default"
    };


    private Task CambiarEstado (string? estado)
    {
        estadoSeleccionado = estado;
        presupuestos = FiltrarPresupuestos(estadoSeleccionado);

        seleccionados.Clear();
        conversionMessage = string.Empty;

        return Task.CompletedTask;
    }

    private int ObtenerConteo(string? estado)
    {
        var baseFiltrada = AplicarFiltrosBase();

        if (string.IsNullOrWhiteSpace(estado))
        {
            return baseFiltrada.Count();
        }

        return baseFiltrada.Count(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase));
    }

    private List<PresupuestoResponseDto> FiltrarPresupuestos(string? estado)
    {
        var baseFiltrada = AplicarFiltrosBase();

        if (string.IsNullOrWhiteSpace(estado))
        {
            return baseFiltrada.OrderByDescending(p => p.FechaEmision).ToList();
        }

        return baseFiltrada
            .Where(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(p => p.FechaEmision)
            .ToList();
    }

    private IEnumerable<PresupuestoResponseDto> AplicarFiltrosBase()
    {
        return presupuestosTodos;
    }

    private bool TodosSeleccionados => presupuestos.Any()
        && presupuestos.All(p => seleccionados.Contains(p.Id));

    private void ToggleSeleccion(PresupuestoResponseDto presupuesto, ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
        {
            seleccionados.Add(presupuesto.Id);
        }
        else
        {
            seleccionados.Remove(presupuesto.Id);
        }
    }

    private void ToggleSeleccionarTodos(ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
        {
            foreach (var presupuesto in presupuestos)
            {
                seleccionados.Add(presupuesto.Id);
            }

            return;
        }

        foreach (var presupuesto in presupuestos)
        {
            seleccionados.Remove(presupuesto.Id);
        }
    }

    private async Task ExportarFacturaAgrupadaAsync()
    {
        conversionMessage = string.Empty;
        errorMessage = string.Empty;

        if(conversionAgrupada.SerieId == 0)
        {
            conversionMessage = "Selecciona una serie de factura.";
            return;
        }

        if (seleccionados.Count == 0)
        {
            conversionMessage = "Selecciona al menos un presupuesto para exportar.";
            return;
        }

        var seleccionadosList = presupuestosTodos.Where(p => seleccionados.Contains(p.Id)).ToList();
        if (seleccionadosList.Any(p => p.Estado != "Aceptado"))
        {
            conversionMessage = "Solo se pueden exportar presupuestos en estado Aceptado.";
            return;
        }

        var clienteId = seleccionadosList.First().ClienteId;
        if (seleccionadosList.Any(p => p.ClienteId != clienteId))
        {
            conversionMessage = "Los presupuestos seleccionados deben ser del mismo cliente.";
            return;
        }

        isConverting = true;

        var request = new ConvertirPresupuestosAFacturaDto
        {
            PresupuestosIds = seleccionadosList.Select(p => p.Id).ToList(),
            SerieId = conversionAgrupada.SerieId,
            FechaEmision = conversionAgrupada.FechaEmision,
            Observaciones = conversionAgrupada.Observaciones,
            PorcentajeRetencion = conversionAgrupada.PorcentajeRetencion
        };

        var result = await ApiService.PostAsync<ConvertirPresupuestosAFacturaDto, FacturaResponseDto>(
            "api/facturas/desde-presupuestos", request);

        if (result == null)
        {
            conversionMessage = "No se pudo exportar la factura agrupada.";
        }
        else
        {
            conversionMessage = $"Factura agrupada generada correctamente: {result.Numero ?? "sin número"}.";
            seleccionados.Clear();
            await CargarPresupuestosAsync(estadoSeleccionado);
        }

        isConverting = false;
    }

    private void NuevoPresupuesto() => NavigationManager.NavigateTo("/presupuestos/nuevo");

    private void EditarPresupuesto(PresupuestoResponseDto presupuesto) =>
        NavigationManager.NavigateTo($"/presupuestos/editar/{presupuesto.Id}");

    private Task EliminarPresupuesto(PresupuestoResponseDto presupuesto)
    {
        var options = new ConfirmDialogOptions(
            "¿Eliminar presupuesto?",
            $"El presupuesto {presupuesto.Id} se borrara permanentemente.",
            "Eliminar",
            "Cancelar"
        );

        confirmDialog.Show(options, async () =>
        {
            var result = await ApiService.DeleteAsyncDetailed($"api/presupuestos/{presupuesto.Id}");

            if (!result.Success)
            {
                var message = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "No se puede eliminar el presupuesto."
                    : result.ErrorMessage;

                throw new InvalidOperationException(message);
            }

            await CargarPresupuestosAsync(estadoSeleccionado);

            await InvokeAsync(StateHasChanged);
        });

        return Task.CompletedTask;
    }

    private async Task DescargarPDF(int id)
    {
        try
        {
            var response = await Http.GetAsync($"api/presupuestos/{id}/pdf");

            if (!response.IsSuccessStatusCode) return;

            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var fileName = $"Presupuesto_{id}.pdf";

            var base64 = Convert.ToBase64String(fileBytes);
            await JS.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading PDF: {ex.Message}");
        }
    }

    private async Task CambiarEstadoIndividual(int presupuestoId, string nuevoEstado)
    {
        var presupuesto = presupuestos.FirstOrDefault(p => p.Id == presupuestoId);
        if(presupuesto == null) return;

        var mensaje = nuevoEstado switch
        {
            "Enviado" => $"¿Marcar presupuesto {presupuesto.NumeroPresupuesto} como Enviado?",
            "Aceptado" => $"¿Marcar presupuesto {presupuesto.NumeroPresupuesto} como Aceptado?\n\nPodrás convertirlo a factura o albarán.",
            "Rechazado" => $"¿Marcar presupuesto {presupuesto.NumeroPresupuesto} como Rechazado?",
            _ => $"¿Cambiar estado del presupuesto {presupuesto.NumeroPresupuesto} a {nuevoEstado}?"
        };

        var options = new ConfirmDialogOptions(
            $"Cambiar estado a {nuevoEstado}",
            mensaje,
            "Confirmar",
            "Cancelar"
        );

        confirmDialog.Show(options, async () =>
        {
            try
            {
                var request = new CambiarEstadoPresupuestoDto { NuevoEstado = nuevoEstado };
                var result = await ApiService.PatchAsync<CambiarEstadoPresupuestoDto, PresupuestoResponseDto>(
                $"api/presupuestos/{presupuestoId}/estado", request);

                if(result == null)
                {
                    errorMessage = $"No se pudo cambiar el estado del presupuesto {presupuesto.NumeroPresupuesto}";
                }
                else
                {
                    conversionMessage = $"Presupuesto {presupuesto.NumeroPresupuesto} marcado como {nuevoEstado}";
                    await CargarPresupuestosAsync(estadoSeleccionado);
                }
            }
            catch(Exception ex)
            {
                errorMessage = $"Error al cambiar estado: {ex.Message}";
            }

            await InvokeAsync(StateHasChanged);
        });
    }

    //Acciones masivas
    private async Task EliminarSeleccionadosAsync()
    {
        if(seleccionados.Count ==0) 
            await Task.CompletedTask;

        var options = new ConfirmDialogOptions(
            "¿Eliminar presupuestos?",
            $"Se borraran {seleccionados.Count} presupesto(s) permanentemente.",
            "Eliminar",
            "Cancelar"
        );

        confirmDialog.Show(options, async () =>
        {
            var ids = seleccionados.ToList();

            foreach (var id in ids)
            {
                var result = await ApiService.DeleteAsyncDetailed($"api/presuestos/{id}");
                if(!result.Success){
                    var msg = string.IsNullOrWhiteSpace(result.ErrorMessage)
                        ? $"No se pudo eliminar el presupuesto {id}"
                        : result.ErrorMessage;

                    throw new InvalidOperationException(msg);
                }
            }

            seleccionados.Clear();
            await CargarPresupuestosAsync(estadoSeleccionado);
            await InvokeAsync(StateHasChanged);
        });

        await Task.CompletedTask;
    }

    private void LimpiarSeleccion()
    {
        seleccionados.Clear();
        conversionMessage = string.Empty;
    }

    private async Task CambioEstadoMasivo(string nuevoEstado, string actualEstado)
    {
        if (!seleccionados.Any()) return;

        //Verificar que todos los seleccionados estan en estado borrador
        var presupuestosBorrador = presupuestos
            .Where(p => seleccionados.Contains(p.Id) && p.Estado == actualEstado)
            .ToList();

        if (!presupuestosBorrador.Any()) return;

        var options = new ConfirmDialogOptions(
            $"Marcar como {nuevoEstado}",
            $"Se marcaran {presupuestosBorrador.Count} presupuesto(s) como {nuevoEstado}",
            "Cambiar estado",
            "Cancelar"
        );

        confirmDialog.Show(options, async () =>
        {
            foreach (var presupuesto in presupuestosBorrador)
            {
                try
                {
                    var request = new CambiarEstadoPresupuestoDto { NuevoEstado = nuevoEstado };
                    var result = await ApiService.PatchAsync<CambiarEstadoPresupuestoDto, PresupuestoResponseDto>(
                        $"api/presupuestos/{presupuesto.Id}/estado", request);

                    if (result == null)
                    {
                        throw new InvalidOperationException($"Error al cambiar el estado del presupuesto {presupuesto.Id}");
                    }
                }
                catch (Exception ex)
                {
                    throw new InvalidOperationException($"Error en presupuesto {presupuesto.Id}: {ex.Message}");
                }
            }
            await CargarPresupuestosAsync(estadoSeleccionado);
            seleccionados.Clear();
            await InvokeAsync(StateHasChanged);
        });


    }

    private async Task DescargarPdfMasivo()
    {
        if (!seleccionados.Any()) return;

        try
        {
            foreach (var id in seleccionados)
            {
                var response = await Http.GetAsync($"api/presupuestos/{id}/pdf");

                if (!response.IsSuccessStatusCode) return;

                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"Presupuesto_{id}.pdf";

                var base64 = Convert.ToBase64String(fileBytes);
                await JS.InvokeVoidAsync("downloadFile", fileName, base64);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloadig PDF: {ex.Message}");
        }
    }

    private sealed class ConversionFacturaAgrupadaModel
    {
        public int SerieId { get; set; } = 1;
        public DateTime FechaEmision { get; set; } = DateTime.Today;
        public string TipoFacturaVERIFACTU { get; set; } = "F1";
        public string? Observaciones { get; set; }
        public decimal? PorcentajeRetencion { get; set; }
    }

}
