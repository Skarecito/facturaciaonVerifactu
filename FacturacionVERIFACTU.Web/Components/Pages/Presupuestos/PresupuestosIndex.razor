@page "/presupuestos"
@using Microsoft.AspNetCore.Authorization
@inject ConfirmDialogService confirmDialog
@attribute [Authorize]

<PageTitle>Presupuestos - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-file-earmark-text"></i>
            </span>
            <div>
                <h1>Presupuesto</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">
            <i class="bi bi-plus-lg"></i> Nuevo Presupuesto
        </button>
    </div>
</div>

    <div class="notion-toolbar" style="border-bottom: 1px solid #edecbd; margin-bottom 24px;">
        <div class="notion-tabs">
            @foreach (var estado in estadosDisponibles)
            {
                <button class="btn-modern-secondary @(estado.Valor == estadoSeleccionado ? "active" : string.Empty)"
                        @onclick="() => CambiarEstado(estado.Valor)">
                    <span>@estado.Etiqueta</span>
                    <span class="tab-count">@ObtenerConteo(estado.Valor)</span>
                </button>
            }
        </div>
    </div>

    <div class="notion-toolbar" style="margin-bottom: 24px;">
        <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 16px; align-items: end;">
            <div class="notion-input-group">
                <label class="notion-label">Serie factura</label>
                <InputNumber @bind-Value="conversionAgrupada.SerieId" class="notion-input-modern" min="1" />
            </div>
            <div class="notion-input-group">
                <label class="notion-label">Fecha emisión</label>
                <InputDate @bind-Value="conversionAgrupada.FechaEmision" class="notion-input-modern" />
            </div>
            <div class="notion-input-group">
                <label class="notion-label">Tipo VERIFACTU</label>
                <InputText @bind-Value="conversionAgrupada.TipoFacturaVERIFACTU" class="notion-input-modern" />
            </div>
            <div>
                <button class="btn-modern" @onclick="ExportarFacturaAgrupadaAsync" disabled="@(isConverting || seleccionados.Count == 0)">
                    @if (isConverting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                    }
                    else
                    {
                        <span><i class="bi bi-receipt"></i> Exportar a Factura (agrupada)</span>
                    }
                </button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(conversionMessage))
        {
            <div class="alert alert-info" style="margin-top: 12px; font-size: 13px; border-radius: 8px; border: none; background-color: #f0f7ff; color: #1b64b0; padding: 12px;">
                <i class="bi bi-info-circle"></i> @conversionMessage
            </div>
        }
    </div>

@if (isLoading)
{
    <div class="notion-loading">
        <div class="spinner-modern"></div>
        <span>Cargando presupuestos ....</span>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
        <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
    </div>
}
else if(presupuestos == null || !presupuestos.Any())
{
    <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
        <i class="bi bi-file-earmark-text" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
        <h4 style="font-weight: 600; margin-bottom: 8px;">No hay presupuestos</h4>
        <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">
            Empieza creando tu primer presupuesto para formalizar propuestas.
        </p>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">Crear presupuesto</button>
    </div>
}
else
{
    {
        <div class="notion-table-wrapper">
            <table class="notion-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--notion-border);">
                        <th style="padding: 12px 16px; width: 4%; text-align: center;">
                            <input type="checkbox" @onchange="ToggleSeleccionarTodos" checked="@TodosSeleccionados" />
                        </th>
                        <th style="padding: 12px 16px; width: 18%; text-align: left;">NÚMERO</th>
                        <th style="padding: 12px 16px; width: 28%; text-align: left;">CLIENTE</th>
                        <th style="padding: 12px 16px; width: 16%; text-align: left;">EMISIÓN</th>
                        <th style="padding: 12px 16px; width: 14%; text-align: right;">TOTAL</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: center;">ESTADO</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var presupuesto in presupuestos)
                    {
                        <tr>
                            <td style="padding: 16px; text-align: center;">
                                <input type="checkbox" checked="@seleccionados.Contains(presupuesto.Id)" @onchange="(e) => ToggleSeleccion(presupuesto, e)" />
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.NumeroPresupuesto</div>
                                <div class="notion-cell-desc">Ejercicio @presupuesto.Ejercicio</div>
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.ClienteNombre</div>
                            </td>
                            <td style="padding: 16px;">
                                <span style="color: #787774; font-size: 14px;">@presupuesto.FechaEmision.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <span style="font-weight: 600;">@presupuesto.Total.ToString("C")</span>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="notion-badge-info">@presupuesto.Estado</span>
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarPresupuesto(presupuesto)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn delete" title="Eliminar"
                                            disabled="@(presupuesto.Estado != "Borrador")"
                                            @onclick="() => EliminarPresupuesto(presupuesto)">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
            <span>Total: @presupuestos.Count presupuestos</span>
        </div>
}
}


@code {
    private sealed record EstadoTab(string Etiqueta, string? Valor);

    private readonly IReadOnlyList<EstadoTab> estadosDisponibles =
    [
        new EstadoTab("Todos", null),
        new EstadoTab("Borrador", "Borrador"),
        new EstadoTab("Enviados", "Enviado"),
        new EstadoTab("Aceptados", "Aceptado"),
        new EstadoTab("Rechazados", "Rechazado")
    ];

    private List<PresupuestoResponseDto> presupuestos = new();
    private List<PresupuestoResponseDto> presupuestosTodos = new();
    private readonly HashSet<int> seleccionados = new();
    private string? estadoSeleccionado;
    private bool isLoading = true;
    private bool isConverting;
    private string errorMessage = string.Empty;
    private string conversionMessage = string.Empty;

    private ConversionFacturaAgrupadaModel conversionAgrupada = new();

    [Inject] private IApiService ApiService { get; set; } = null;
    [Inject] private NavigationManager NavigationManager { get; set; } = null;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarPresupuestosAsync();
    }

    private async Task CargarPresupuestosAsync(string? estado = null)
    {
        isLoading = true;
        errorMessage = string.Empty;
        conversionMessage = string.Empty;

        var response = await ApiService.GetAsync<List<PresupuestoResponseDto>>("api/Presupuestos");
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los presupuestos";
            presupuestos = new List<PresupuestoResponseDto>();
            presupuestosTodos = new List<PresupuestoResponseDto>();
            seleccionados.Clear();
        }
        else
        {
            presupuestosTodos = response;
            presupuestos = FiltrarPresupuestos(estado);
            seleccionados.RemoveWhere(id => presupuestosTodos.All(p => p.Id != id));
        }

        isLoading = false;
    }

    private Task CambiarEstado (string? estado)
    {
        estadoSeleccionado = estado;
        presupuestos = FiltrarPresupuestos(estadoSeleccionado);
        return Task.CompletedTask;
    }

    private int ObtenerConteo(string? estado)
    {
        var baseFiltrada = AplicarFiltrosBase();

        if (string.IsNullOrWhiteSpace(estado))
        {
            return baseFiltrada.Count();
        }

        return baseFiltrada.Count(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase));
    }

    private List<PresupuestoResponseDto> FiltrarPresupuestos(string? estado)
    {
        var baseFiltrada = AplicarFiltrosBase();

        if (string.IsNullOrWhiteSpace(estado))
        {
            return baseFiltrada.OrderByDescending(p => p.FechaEmision).ToList();
        }

        return baseFiltrada
            .Where(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(p => p.FechaEmision)
            .ToList();
    }

    private IEnumerable<PresupuestoResponseDto> AplicarFiltrosBase()
    {
        return presupuestosTodos;
    }

    private bool TodosSeleccionados => presupuestos.Any()
        && presupuestos.All(p => seleccionados.Contains(p.Id));

    private void ToggleSeleccion(PresupuestoResponseDto presupuesto, ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
        {
            seleccionados.Add(presupuesto.Id);
        }
        else
        {
            seleccionados.Remove(presupuesto.Id);
        }
    }

    private void ToggleSeleccionarTodos(ChangeEventArgs args)
    {
        if (args.Value is bool isChecked && isChecked)
        {
            foreach (var presupuesto in presupuestos)
            {
                seleccionados.Add(presupuesto.Id);
            }

            return;
        }

        foreach (var presupuesto in presupuestos)
        {
            seleccionados.Remove(presupuesto.Id);
        }
    }

    private async Task ExportarFacturaAgrupadaAsync()
    {
        conversionMessage = string.Empty;
        errorMessage = string.Empty;

        if (seleccionados.Count == 0)
        {
            conversionMessage = "Selecciona al menos un presupuesto para exportar.";
            return;
        }

        var seleccionadosList = presupuestosTodos.Where(p => seleccionados.Contains(p.Id)).ToList();
        if (seleccionadosList.Any(p => p.Estado != "Aceptado"))
        {
            conversionMessage = "Solo se pueden exportar presupuestos en estado Aceptado.";
            return;
        }

        var clienteId = seleccionadosList.First().ClienteId;
        if (seleccionadosList.Any(p => p.ClienteId != clienteId))
        {
            conversionMessage = "Los presupuestos seleccionados deben ser del mismo cliente.";
            return;
        }

        isConverting = true;

        var request = new ConvertirPresupuestosAFacturaDto
        {
            PresupuestosIds = seleccionadosList.Select(p => p.Id).ToList(),
            SerieId = conversionAgrupada.SerieId,
            FechaEmision = conversionAgrupada.FechaEmision,
            Observaciones = conversionAgrupada.Observaciones,
            PorcentajeRetencion = conversionAgrupada.PorcentajeRetencion
        };

        var result = await ApiService.PostAsync<ConvertirPresupuestosAFacturaDto, FacturaResponseDto>(
            "api/facturas/desde-presupuestos", request);

        if (result == null)
        {
            conversionMessage = "No se pudo exportar la factura agrupada.";
        }
        else
        {
            conversionMessage = $"Factura agrupada generada correctamente: {result.Numero ?? "sin número"}.";
            seleccionados.Clear();
            await CargarPresupuestosAsync(estadoSeleccionado);
        }

        isConverting = false;
    }

    private void NuevoPresupuesto() => NavigationManager.NavigateTo("/presupuestos/nuevo");

    private void EditarPresupuesto(PresupuestoResponseDto presupuesto) =>
        NavigationManager.NavigateTo($"/presupuestos/editar/{presupuesto.Id}");

    private Task EliminarPresupuesto(PresupuestoResponseDto presupuesto)
    {
        var options = new ConfirmDialogOptions(
            "¿Eliminar presupuesto?",
            $"El presupuesto {presupuesto.Id} se borrara permanentemente.",
            "Eliminar",
            "Cancelar"
        );

        confirmDialog.Show(options, async () =>
        {
            var result = await ApiService.DeleteAsyncDetailed($"api/presupuestos/{presupuesto.Id}");

            if (!result.Success)
            {
                var message = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "No se puede eliminar el presupuesto."
                    : result.ErrorMessage;

                throw new InvalidOperationException(message);
            }

            await CargarPresupuestosAsync(estadoSeleccionado);

            await InvokeAsync(StateHasChanged);
        });

        return Task.CompletedTask;
    }

    private sealed class ConversionFacturaAgrupadaModel
    {
        public int SerieId { get; set; } = 1;
        public DateTime FechaEmision { get; set; } = DateTime.Today;
        public string TipoFacturaVERIFACTU { get; set; } = "F1";
        public string? Observaciones { get; set; }
        public decimal? PorcentajeRetencion { get; set; }
    }

}
