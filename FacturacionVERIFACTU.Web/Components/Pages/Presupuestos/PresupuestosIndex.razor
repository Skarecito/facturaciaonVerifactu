@page "/presupuestos"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Presupuestos - FacturacionVERIFACTU</PageTitle>

<div class="notion-content">
    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-file-earmark-text"></i>
            </span>
            <div>
                <h1>Presupuesto</h1>
            </div>
        </div>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">
            <i class="bi bi-plus-lg"></i> Nuevo Presupuesto
        </button>
    </div>
</div>

<div class="notion-toolbar" style="border-bottom: 1px solid #edecbd; margin-bottom 24px;">
    <div class="notion-tabs">
        @foreach (var estado in estadosDisponibles)
        {
            <button class="btn-modern-secondary @(estado.Valor == estadoSeleccionado ? "active" : string.Empty)"
                    @onclick="() => CambiarEstado(estado.Valor)">
                <span>@estado.Etiqueta</span>
                <span class="tab-count">@ObtenerConteo(estado.Valor)</span>
            </button>
        }
    </div>
</div>

@if (isLoading)
{
    <div class="notion-loading">
        <div class="spinner-modern"></div>
        <span>Cargando presupuestos ....</span>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
        <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
    </div>
}
else if(presupuestos == null || !presupuestos.Any())
{
    <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
        <i class="bi bi-file-earmark-text" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
        <h4 style="font-weight: 600; margin-bottom: 8px;">No hay presupuestos</h4>
        <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">
            Empieza creando tu primer presupuesto para formalizar propuestas.
        </p>
        <button class="btn-modern-secondary" @onclick="NuevoPresupuesto">Crear presupuesto</button>
    </div>
}
else
{
    {
        <div class="notion-table-wrapper">
            <table class="notion-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--notion-border);">
                        <th style="padding: 12px 16px; width: 18%; text-align: left;">NÚMERO</th>
                        <th style="padding: 12px 16px; width: 30%; text-align: left;">CLIENTE</th>
                        <th style="padding: 12px 16px; width: 16%; text-align: left;">EMISIÓN</th>
                        <th style="padding: 12px 16px; width: 14%; text-align: right;">TOTAL</th>
                        <th style="padding: 12px 16px; width: 12%; text-align: center;">ESTADO</th>
                        <th style="padding: 12px 16px; width: 10%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var presupuesto in presupuestos)
                    {
                        <tr>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.NumeroPresupuesto</div>
                                <div class="notion-cell-desc">Ejercicio @presupuesto.Ejercicio</div>
                            </td>
                            <td style="padding: 16px;">
                                <div class="notion-cell-title">@presupuesto.ClienteNombre</div>
                            </td>
                            <td style="padding: 16px;">
                                <span style="color: #787774; font-size: 14px;">@presupuesto.FechaEmision.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <span style="font-weight: 600;">@presupuesto.Total.ToString("C")</span>
                            </td>
                            <td style="padding: 16px; text-align: center;">
                                <span class="notion-badge-info">@presupuesto.Estado</span>
                            </td>
                            <td style="padding: 16px; text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 4px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarPresupuesto(presupuesto)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn delete" title="Eliminar"
                                            disabled="@(presupuesto.Estado != "Borrador")"
                                            @onclick="() => EliminarPresupuesto(presupuesto)">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 20px; border-top: 1px solid #edeceb; padding-top: 12px; color: rgba(55, 53, 47, 0.4); font-size: 12px;">
            <span>Total: @presupuestos.Count presupuestos</span>
        </div>
}
}


@code {
    private sealed record EstadoTab(string Etiqueta, string? Valor);

    private readonly IReadOnlyList<EstadoTab> estadosDisponibles =
    [
        new EstadoTab("Todos", null),
        new EstadoTab("Borrador", "Borrador"),
        new EstadoTab("Enviados", "Enviado"),
        new EstadoTab("Aceptados", "Aceptado"),
        new EstadoTab("Rechazados", "Rechazado")
    ];

    private List<PresupuestoResponseDto> presupuestos = new();
    private List<PresupuestoResponseDto> presupuestosTodos = new();
    private string? estadoSeleccionado;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    [Inject] private IApiService ApiService { get; set; } = null;
    [Inject] private NavigationManager NavigationManager { get; set; } = null;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        await CargarPresupuestosAsync();
    }

    private async Task CargarPresupuestosAsync(string? estado = null)
    {
        isLoading = true;
        errorMessage = string.Empty;

        var response = await ApiService.GetAsync<List<PresupuestoResponseDto>>("api/Presupuestos");
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los presupuestos";
            presupuestos = new List<PresupuestoResponseDto>();
            presupuestosTodos = new List<PresupuestoResponseDto>();
        }
        else
        {
            presupuestosTodos = response;
            presupuestos = FiltrarPresupuestos(estado);
        }

        isLoading = false;
    }

    private async Task CambiarEstado (string? estado)
    {
        estadoSeleccionado = estado;
        presupuestos = FiltrarPresupuestos(estadoSeleccionado);
    }

    private int ObtenerConteo(string? estado)
    {
        if (!string.IsNullOrWhiteSpace(estado))
        {
            return presupuestosTodos.Count;
        }

        return presupuestosTodos.Count(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase));
    }

    private List<PresupuestoResponseDto> FiltrarPresupuestos(string? estado)
    {
        if (string.IsNullOrWhiteSpace(estado))
        {
            return presupuestosTodos.OrderByDescending(p => p.FechaEmision).ToList();
        }

        return presupuestosTodos
            .Where(p => p.Estado.Equals(estado, StringComparison.OrdinalIgnoreCase))
            .OrderByDescending(p => p.FechaEmision)
            .ToList();
    }

    private void NuevoPresupuesto() => NavigationManager.NavigateTo("/presupuestos/nuevo");

    private void EditarPresupuesto(PresupuestoResponseDto presupuesto) =>
        NavigationManager.NavigateTo($"/presupuestos/editar/{presupuesto.Id}");

    private async Task EliminarPresupuesto(PresupuestoResponseDto presupuesto)
    {
        if(presupuesto.Estado != "Borrador")
        {
            return;
        }

        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Eliminar el presupuesto {presupuesto.NumeroPresupuesto}?");

        if (!confirm)
        {
            return;
        }

        var success = await ApiService.DeleteAsync($"api/Presupuestos/{presupuesto.Id}");
        if (!success)
        {
            errorMessage = "No se puedo eliminar el presupuesto";
            return;
        }

        await CargarPresupuestosAsync(estadoSeleccionado);
    }


}
