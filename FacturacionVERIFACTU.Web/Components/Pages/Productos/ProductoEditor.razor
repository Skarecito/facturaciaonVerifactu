@page "/productos/nuevo"
@page "/productos/editar/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]


<div class="notion-content">
    <div class="notion-breadcrumb">
        <a href="/productos">Productos</a> / @(Id == 0 ? "Nuevo" : "Editar")
    </div>

    <div class="notion-page-header">
        <div class="header-main">
            <span class="header-icon">@(Id == 0 ? "📦" : "✏️")</span>
            <div>
                <h1>@(Id == 0 ? "Nuevo producto" : "Editar producto")</h1>
                <p>Define los precios, impuestos y códigos de tu catálogo.</p>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 8px; border: none; background-color: #fff0f0; color: #e03e3e; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
        </div>
    }

    <EditForm Model="producto" OnValidSubmit="GuardarAsync" class="notion-form-container">
        <DataAnnotationsValidator />

        <div class="notion-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">

            @* Fila 1: Código (Principal) *@
            <div class="notion-input-group" style="grid-column: span 1;">
                <label class="notion-label">Código del Producto</label>
                <InputText @bind-Value="producto.Codigo" class="notion-input-modern" disabled="@(Id > 0)" placeholder="Ej: REF-001" />
                <ValidationMessage For="() => producto.Codigo" class="notion-error" />
            </div>

            <div class="notion-input-group" style="grid-column: span 1;">
                <label class="notion-label">Unidad de Medida</label>
                <InputText @bind-Value="producto.Unidad" class="notion-input-modern" placeholder="Ud, Horas, Kg..." />
            </div>

            @* Fila 2: Descripción (Ancho completo) *@
            <div class="notion-input-group" style="grid-column: span 2;">
                <label class="notion-label">Descripción</label>
                <InputText @bind-Value="producto.Descripcion" class="notion-input-modern" placeholder="Nombre o descripción detallada del servicio" />
                <ValidationMessage For="() => producto.Descripcion" class="notion-error" />
            </div>

            @* Fila 3: Valores Económicos *@
            <div class="notion-input-group">
                <label class="notion-label">Precio Unitario (€)</label>
                <InputNumber @bind-Value="producto.PrecioUnitario" class="notion-input-modern" step="0.01" />
                <ValidationMessage For="() => producto.PrecioUnitario" class="notion-error" />
            </div>

            <div class="notion-input-group">
                <label class="notion-label">IVA (%)</label>
                <InputNumber @bind-Value="producto.IVA" class="notion-input-modern" />
                <ValidationMessage For="() => producto.IVA" class="notion-error" />
            </div>

            @* Fila 4: Estado *@
            <div class="notion-input-group" style="grid-column: span 2; display: flex; align-items: center; gap: 10px; padding: 10px 0;">
                <InputCheckbox @bind-Value="producto.Activo" id="chkActivo" style="width: 18px; height: 18px; accent-color: #000; cursor: pointer;" />
                <label for="chkActivo" style="font-size: 14px; font-weight: 500; cursor: pointer; margin-bottom: 0;">Producto disponible para la venta</label>
            </div>
        </div>

        @* --- ACCIONES ESTILO LOGIN --- *@
        <div class="notion-form-actions" style="display: flex; gap: 12px; margin-top: 30px; border-top: 1px solid #edeceb; padding-top: 25px;">
            <button type="submit" class="btn-modern" style="min-width: 140px;" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                }
                else
                {
                    <span>Guardar producto</span>
                }
            </button>

            <button type="button" class="btn-modern-secondary" style="min-width: 140px;" @onclick="Cancelar">
                Cancelar
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private ProductoDto producto = new();
    private bool isSaving;
    private string errorMessage = string.Empty;

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        if (Id <= 0)
        {
            return;
        }

        var response = await ApiService.GetAsync<ProductoDto>($"api/productos/{Id}");
        if (response == null)
        {
            errorMessage = "No se pudo cargar el producto seleccionado.";
            return;
        }

        producto = response;
    }

    private async Task GuardarAsync()
    {
        isSaving = true;
        errorMessage = string.Empty;

        if (Id == 0)
        {
            var request = new CrearProductoDto
            {
                Codigo = producto.Codigo,
                Descripcion = producto.Descripcion,
                PrecioUnitario = producto.PrecioUnitario,
                IVA = producto.IVA,
                Unidad = producto.Unidad,
                Activo = producto.Activo
            };

            var result = await ApiService.PostAsync<CrearProductoDto, ProductoDto>("api/productos", request);
            if (result == null)
            {
                errorMessage = "No se pudo crear el producto.";
                isSaving = false;
                return;
            }
        }
        else
        {
            var request = new ActualizarProductoDto
            {
                Descripcion = producto.Descripcion,
                PrecioUnitario = producto.PrecioUnitario,
                IVA = producto.IVA,
                Unidad = producto.Unidad,
                Activo = producto.Activo
            };

            var result = await ApiService.PutAsync<ActualizarProductoDto, ProductoDto>($"api/productos/{Id}", request);
            if (result == null)
            {
                errorMessage = "No se pudo actualizar el producto.";
                isSaving = false;
                return;
            }
        }

        NavManager.NavigateTo("/productos");
    }

    private void Cancelar() => NavManager.NavigateTo("/productos");
}
