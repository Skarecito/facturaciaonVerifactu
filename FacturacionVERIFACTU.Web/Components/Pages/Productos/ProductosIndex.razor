@page "/productos"
@using Microsoft.AspNetCore.Authorization
@inject ConfirmDialogService ConfirmDialog
@attribute [Authorize]

<PageTitle>Productos - FacturaVERIFACTU</PageTitle>

<div class="notion-content">

    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-archive"></i>
            </span>
            <div>
                <h1>Productos</h1>
            </div>
        </div>
        <button class="btn-modern" @onclick="NuevoProducto">
            <i class="bi bi-plus-lg"></i> Nuevo Producto
        </button>
    </div>

    @* Toolbar de búsqueda *@
    <div class="notion-toolbar" style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 10px; background: white; border: 1.5px solid #e0e0e0; border-radius: 10px; padding: 10px 16px; max-width: 420px; transition: all 0.2s;">
            <i class="bi bi-search" style="font-size: 15px; color: rgba(15,23,42,.40);"></i>
            <input @bind="searchText"
                   @bind:event="oninput"
                   @onkeyup="Buscar"
                   placeholder="Buscar por código o descripción..."
                   style="border: none !important; outline: none !important; background: transparent !important; width: 100%; font-size: 14px; color: #0f172a; box-shadow: none !important; padding: 0 !important; margin: 0 !important; border-radius: 0 !important;" />
        </div>
    </div>

    @* Contenido principal *@
    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando catálogo...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 12px; border: 1px solid rgba(239,68,68,.18); background-color: rgba(239,68,68,.10); color: #b91c1c; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
            <button class="btn-modern-secondary" style="margin-left: 12px; padding: 4px 10px; font-size: 12px;" @onclick="() => CargarProductosAsync(searchText)">Reintentar</button>
        </div>
    }
    else if (productos == null || !productos.Any())
    {
        <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
            <i class="bi bi-box-seam" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
            <h4 style="font-weight: 600; margin-bottom: 8px;">No hay productos</h4>
            <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">
                Gestiona tus artículos y servicios para agilizar tus facturas.
            </p>
            <button class="btn-modern-secondary" @onclick="NuevoProducto">Añadir primer producto</button>
        </div>
    }
    else
    {
        <div class="notion-table-wrapper">
            <table class="notion-table">
                <thead>
                    <tr>
                        <th style="width: 15%; text-align: left;">CÓDIGO</th>
                        <th style="width: 40%; text-align: left;">DESCRIPCIÓN</th>
                        <th style="width: 15%; text-align: right;">PRECIO</th>
                        <th style="width: 10%; text-align: center;">IVA</th>
                        <th style="width: 10%; text-align: center;">ESTADO</th>
                        <th style="width: 10%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var producto in productos)
                    {
                        <tr class="@(producto.Activo ? "" : "notion-row-inactive")">
                            <td>
                                <span class="notion-code-text">@producto.Codigo</span>
                            </td>
                            <td style="max-width: 0;">
                                <div class="notion-cell-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    @producto.Descripcion
                                </div>
                            </td>
                            <td style="text-align: right;">
                                <span style="font-weight: 700;">@producto.PrecioUnitario.ToString("C")</span>
                            </td>
                            <td style="text-align: center;">
                                <span class="notion-badge badge-info">
                                    @((producto.PorcentajeIva ?? 0m).ToString("N0"))%
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <span class="notion-badge @(producto.Activo ? "active" : "inactive")">
                                    @(producto.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td style="text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 6px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarProducto(producto)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn delete" title="Eliminar"
                                            @onclick="() => EliminarProducto(producto)">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 14px; color: rgba(15,23,42,.50); font-size: 12px;">
            <span>Total: @productos.Count productos en catálogo</span>
        </div>
    }

</div>

@code {
    private List<ProductoDto> productos = new();
    private string searchText = string.Empty;
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await CargarProductosAsync();
    }

    private async Task CargarProductosAsync(string? search = null)
    {
        isLoading = true;
        errorMessage = string.Empty;

        var endpoint = string.IsNullOrWhiteSpace(search)
            ? "api/productos"
            : $"api/productos?search={Uri.EscapeDataString(search)}";

        var response = await ApiService.GetAsync<PaginatedResponseDto<ProductoDto>>(endpoint);

        if (response == null)
        {
            errorMessage = "No se pudieron cargar los productos.";
            productos = new List<ProductoDto>();
        }
        else
        {
            productos = response.Items ?? new List<ProductoDto>();
        }

        isLoading = false;
    }

    private async Task Buscar()
    {
        await CargarProductosAsync(searchText);
        await InvokeAsync(StateHasChanged);
    }

    private void NuevoProducto() => NavManager.NavigateTo("/productos/nuevo");

    private void EditarProducto(ProductoDto producto)
        => NavManager.NavigateTo($"/productos/editar/{producto.ProductoId}");

    private Task EliminarProducto(ProductoDto producto)
    {
        var options = new ConfirmDialogOptions(
            "¿Eliminar producto?",
            $"El producto {producto.Codigo} se borrará permanentemente.",
            "Eliminar",
            "Cancelar"
        );

        ConfirmDialog.Show(options, async () =>
        {
            var result = await ApiService.DeleteAsyncDetailed($"api/productos/{producto.ProductoId}");

            if (!result.Success)
            {
                var message = string.IsNullOrWhiteSpace(result.ErrorMessage)
                    ? "No se puede eliminar el producto."
                    : result.ErrorMessage;

                throw new InvalidOperationException(message);
            }

            await CargarProductosAsync(searchText);
            await InvokeAsync(StateHasChanged);
        });

        return Task.CompletedTask;
    }
}
