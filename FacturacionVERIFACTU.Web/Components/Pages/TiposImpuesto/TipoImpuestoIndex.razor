@page "/tipos-impuesto"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<PageTitle>Tipos de impuesto - FacturaVERIFACTU</PageTitle>

<div class="notion-content">

    <div class="notion-header">
        <div class="header-main">
            <span class="header-icon">
                <i class="bi bi-percent"></i>
            </span>
            <div>
                <h1>Tipos de impuesto</h1>
            </div>
        </div>
        <button class="btn-modern" @onclick="NuevoTipo">
            <i class="bi bi-plus-lg"></i> Nuevo Tipo
        </button>
    </div>

    @if (isLoading)
    {
        <div class="notion-loading">
            <div class="spinner-modern"></div>
            <span>Cargando tipos de impuesto...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" style="font-size: 13px; border-radius: 12px; border: 1px solid rgba(239,68,68,.18); background-color: rgba(239,68,68,.10); color: #b91c1c; margin-bottom: 20px; padding: 12px;">
            <i class="bi bi-exclamation-circle-fill"></i> @errorMessage
            <button class="btn-modern-secondary" style="margin-left: 12px; padding: 4px 10px; font-size: 12px;" @onclick="CargarTiposAsync">Reintentar</button>
        </div>
    }
    else if (tiposImpuesto == null || !tiposImpuesto.Any())
    {
        <div class="notion-empty-state" style="padding: 80px 0; text-align: center;">
            <i class="bi bi-percent" style="font-size: 48px; color: #edeceb; margin-bottom: 16px; display: block;"></i>
            <h4 style="font-weight: 600; margin-bottom: 8px;">No hay tipos de impuesto</h4>
            <p style="color: #787774; font-size: 14px; margin-bottom: 24px;">Crea tipos para aplicar IVA y recargo por tenant.</p>
            <button class="btn-modern-secondary" @onclick="NuevoTipo">Añadir tipo</button>
        </div>
    }
    else
    {
        <div class="notion-table-wrapper">
            <table class="notion-table">
                <thead>
                    <tr>
                        <th style="width: 35%; text-align: left;">NOMBRE</th>
                        <th style="width: 20%; text-align: right;">IVA</th>
                        <th style="width: 20%; text-align: right;">RECARGO</th>
                        <th style="width: 12%; text-align: center;">ESTADO</th>
                        <th style="width: 13%; text-align: right;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tipo in tiposImpuesto)
                    {
                        <tr class="@(tipo.Activo ? "" : "notion-row-inactive")">
                            <td>
                                <div class="notion-cell-title">@tipo.Nombre</div>
                            </td>
                            <td style="text-align: right;">
                                <span class="notion-badge badge-info">@tipo.PorcentajeIva.ToString("N2")%</span>
                            </td>
                            <td style="text-align: right;">
                                @if (tipo.PorcentajeRecargo.HasValue)
                                {
                                    <span class="notion-badge badge-warning">@tipo.PorcentajeRecargo.Value.ToString("N2")%</span>
                                }
                                else
                                {
                                    <span style="color: rgba(15,23,42,.35); font-size: 14px;">—</span>
                                }
                            </td>
                            <td style="text-align: center;">
                                <span class="notion-badge @(tipo.Activo ? "active" : "inactive")">
                                    @(tipo.Activo ? "Activo" : "Inactivo")
                                </span>
                            </td>
                            <td style="text-align: right;">
                                <div class="notion-actions" style="justify-content: flex-end; gap: 6px;">
                                    <button class="notion-action-btn" title="Editar"
                                            @onclick="() => EditarTipo(tipo)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="notion-action-btn @(tipo.Activo ? "delete" : "")"
                                            title="@(tipo.Activo ? "Desactivar" : "Activar")"
                                            @onclick="() => CambiarEstado(tipo)">
                                        <i class="bi bi-power"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="notion-table-footer" style="margin-top: 14px; color: rgba(15,23,42,.50); font-size: 12px;">
            <span>Total: @tiposImpuesto.Count tipos configurados</span>
        </div>
    }

</div>

@code {
    private List<TipoImpuestoListadoDto> tiposImpuesto = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    [Inject] private IApiService ApiService { get; set; } = null!;
    [Inject] private NavigationManager NavManager { get; set; } = null!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await CargarTiposAsync();
    }

    private async Task CargarTiposAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        var response = await ApiService.GetAsync<List<TipoImpuestoListadoDto>>("api/tiposimpuesto");
        if (response == null)
        {
            errorMessage = "No se pudieron cargar los tipos de impuesto.";
            tiposImpuesto = new List<TipoImpuestoListadoDto>();
        }
        else
        {
            tiposImpuesto = response;
        }

        isLoading = false;
    }

    private void NuevoTipo() => NavManager.NavigateTo("/tipos-impuesto/nuevo");

    private void EditarTipo(TipoImpuestoListadoDto tipo) => NavManager.NavigateTo($"/tipos-impuesto/editar/{tipo.Id}");

    private async Task CambiarEstado(TipoImpuestoListadoDto tipo)
    {
        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"¿{(tipo.Activo ? "Desactivar" : "Activar")} el tipo {tipo.Nombre}?");
        if (!confirm) return;

        var request = new ActualizarTipoImpuestoDto
        {
            Nombre = tipo.Nombre,
            PorcentajeIVA = tipo.PorcentajeIva,
            PorcentajeRecargo = tipo.PorcentajeRecargo,
            Activo = !tipo.Activo
        };

        var result = await ApiService.PutAsync<ActualizarTipoImpuestoDto, TipoImpuestoDto>($"api/tiposimpuesto/{tipo.Id}", request);
        if (result == null)
        {
            errorMessage = "No se pudo actualizar el estado del tipo.";
            return;
        }

        await CargarTiposAsync();
    }
}
